<!DOCTYPE html>
<html lang="pt-BR">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Console — Painel & Cadastro</title>
      <link rel="icon" href="/static/favicon.png">
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
      <style>
         :root {
         --primary: #13539b; 
         --primary-light: #2563eb; 
         --primary-dark: #0f172a;
         --accent: #fa6827;
         --accent-light: #fb7c47;
         --accent-dark: #e85d24;
         --surface: #ffffff; 
         --surface-hover: #f1f5f9; 
         --ink: #0f172a; 
         --muted: #64748b;
         --stroke: #e2e8f0; 
         --stroke-light: #f1f5f9;
         --radius: 16px; 
         --radius-lg: 24px;
         --shadow-sm: 0 2px 8px rgba(19,83,155,.08); 
         --shadow: 0 8px 32px rgba(19,83,155,.12);
         --shadow-accent: 0 4px 16px rgba(250,104,39,.15);
         --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
         --gradient-accent: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
         }
         *{box-sizing:border-box;margin:0;padding:0}
         body{
         font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;
         line-height:1.6;color:var(--ink);
         background:linear-gradient(135deg,#f8fcff 0%,#f1f2f8 100%);
         min-height:100vh
         }
         @font-face {
         font-family: 'MinhaFonte';
         src: url('/static/Nulshock.woff2') format('woff2');
         font-weight: 900;
         font-display: swap;
         }
         .header{background:var(--gradient-primary);color:#fff;padding:32px 40px}
         .header h1{
         font-family:'MinhaFonte','Inter',sans-serif;font-size:36px;font-weight:900;
         margin-bottom:12px;color:#ffffff;letter-spacing:0.025em;
         }
         .header h1 .first-letter,
         .header h1 .first-letter-admin{ color:var(--accent); font-size:50px; }
         .header .subtitle{ font-size:16px; opacity:0.9; font-weight:400; letter-spacing:0.025em; }
         .tabs{display:flex;gap:4px;background:#fff;padding:8px;border-bottom:1px solid var(--stroke);box-shadow:var(--shadow-sm)}
         .tab{border:none;background:transparent;padding:16px 24px;border-radius:16px;cursor:pointer;font-weight:600;font-size:14px;color:var(--muted);transition:.2s}
         .tab[aria-selected="true"]{background:var(--gradient-primary);color:#fff;box-shadow:var(--shadow)}
         .tab:hover:not([aria-selected="true"]){background:var(--surface-hover);color:var(--ink)}
         main{padding:32px 40px;max-width:1400px;margin:0 auto}
         .view{display:none}.view.active{display:block}
         .card{background:#fff;border:1px solid var(--stroke);border-radius:24px;padding:32px;margin-bottom:32px;box-shadow:var(--shadow);position:relative}
         .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gradient-primary)}
         .table-container{background:#fff;border:1px solid var(--stroke);border-radius:24px;overflow:hidden;box-shadow:var(--shadow)}
         table{width:100%;border-collapse:separate;border-spacing:0}
         th,td{padding:16px 20px;text-align:left;border-bottom:1px solid var(--stroke);font-size:14px}
         th{
         background:linear-gradient(135deg,var(--stroke-light) 0%,#f8fafc 100%);
         font-weight:700;color:var(--ink);text-transform:uppercase;letter-spacing:.025em;
         position:sticky;top:0;z-index:1
         }
         tbody tr{transition:.2s}
         tbody tr:hover{background:linear-gradient(135deg,rgba(0,96,86,.03) 0%, rgba(16,185,129,.02) 100%)}
         .pill{display:inline-flex;align-items:center;padding:6px 12px;border-radius:20px;background:var(--stroke-light);font-weight:600;font-size:12px;color:var(--ink)}
         .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
         input,select{
         padding:12px 16px;border:2px solid var(--stroke);border-radius:16px;background:#fff;
         font-size:14px;font-weight:500;color:var(--ink);transition:.2s;min-width:180px
         }
         input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(0,96,86,.1)}
         .btn{
         border:none;background:var(--gradient-primary);color:#fff;padding:12px 20px;border-radius:16px;
         cursor:pointer;font-weight:600;font-size:14px;display:inline-flex;align-items:center;gap:10px;
         transition:.2s;box-shadow:var(--shadow-sm)
         }
         .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
         .btn--ghost{background:#fff;color:var(--primary);border:1px solid var(--stroke);box-shadow:none}
         .actions{display:flex;gap:8px;align-items:center}
         /* ================== Painel ================== */
         #painel .filters{
         display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
         gap:20px;background:#fff;padding:24px;border:1px solid var(--stroke);
         border-radius:24px;box-shadow:var(--shadow);margin-bottom:24px
         }
         #painel .actions{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
         #painel .actions .push-right{margin-left:auto}
         #painel .btn{border:1px solid var(--stroke);background:#fff;border-radius:16px;padding:12px 20px;color:var(--ink)}
         #painel .btn--primary{
         background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);
         color:#fff;border-color:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%)
         }
         /* Monitoramento */
         #painel .btn--live{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;border-color:linear-gradient(135deg,#10b981 0%,#059669 100%)}
         #painel .btn--live .dot{width:12px;height:12px;border-radius:999px;background:#ef4444;display:inline-block}
         #painel .btn--live.is-on{background:linear-gradient(135deg,#fecaca 0%, #fca5a5 100%);color:#7f1d1d;border-color:#f87171;box-shadow:0 0 0 4px rgba(248,113,113,.25)}
         #painel .btn--live.is-on .dot{display:none}
         /* Status texto */
         #painel .status{background:transparent!important;border:0!important;padding:0!important;min-width:unset;font-weight:600;font-size:14px;color:var(--ink)}
         #painel .count{font-size:14px;color:var(--muted);font-weight:500;margin-bottom:16px;padding:12px 16px;background:#fff;border-radius:16px;border:1px solid var(--stroke)}
         #painel .table-wrap{overflow-x:auto}
         #painel table{min-width:1000px}
         #painel .title{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;color:var(--ink)}
         /* Modal genérico */
         #painel .modal{position:fixed;inset:0;background:rgba(15,23,42,.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:9999}
         #painel .modal__box{width:min(800px,95vw);max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--stroke);border-radius:16px;padding:32px;box-shadow:var(--shadow)}
         #painel .modal__title{font-weight:800;font-size:24px;margin-bottom:20px}
         #painel .modal__body{
         white-space:pre-wrap;border:1px solid var(--stroke);
         background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);
         border-radius:12px;padding:20px;font-family:ui-monospace,Consolas,Menlo,monospace;
         font-size:14px;line-height:1.6;color:var(--ink);max-height:400px;overflow-y:auto;
         margin-bottom:24px
         }
         #painel .modal__actions{margin-top:8px;text-align:right}
         
         /* Modal de Notificação */
         .notification-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: notificationFadeIn 0.3s ease-out;
         }
         
         .notification-content {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.3);
            border: 3px solid #fff;
            max-width: 400px;
            width: 90vw;
            animation: notificationBounce 0.5s ease-out;
         }
         
         .notification-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: notificationPulse 1s infinite;
         }
         
         .notification-title {
            color: #fff;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
         }
         
         .notification-message {
            color: #fff;
            font-size: 16px;
            margin-bottom: 30px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
         }
         
         .notification-actions .btn {
            background: #fff;
            color: #ff6b6b;
            font-weight: 700;
            font-size: 18px;
            padding: 15px 40px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
         }
         
         .notification-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
         }
         
         @keyframes notificationFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
         }
         
         @keyframes notificationBounce {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
         }
         
         @keyframes notificationPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
         }
         #painel .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--stroke);border-radius:50%;border-top-color:var(--primary);animation:spin 1s ease-in-out infinite}
         @keyframes spin{to{transform:rotate(360deg)}}
         /* === BOTÕES COMPACTOS NA TABELA === */
         #painel table .btn,
         #painel table [data-kind="whatsapp-link"],
         #painel table [data-kind="trello-link"]{
         padding:6px 10px !important; line-height:1 !important; border-radius:10px !important;
         font-size:12px !important; display:inline-flex !important; align-items:center !important;
         font-weight:700 !important; gap:6px !important; min-width:unset !important; height:28px !important;
         box-sizing:border-box !important; text-decoration:none; vertical-align:middle !important;
         }
         /* conteúdo da coluna AÇÕES dentro da tabela */
         #painel table .actions{
         display:flex !important; justify-content:center !important; align-items:center !important;
         height:28px !important; margin:0 !important; padding:0 !important;
         }
         /* Ghost compacto */
         #painel table .btn--ghost{
         background:#fff !important; color:var(--primary) !important; border:1px solid var(--stroke) !important; box-shadow:none !important;
         }
         #painel table .btn--ghost:hover{ background:var(--surface-hover) !important; transform:none !important; }
         /* Linhas compactas */
         #painel table td{ vertical-align:middle !important; padding:8px 16px !important; height:40px !important; }
         /* === Status cores === */
         #painel .status.s-open{color:#22c55e}
         #painel .status.s-analise{color:#eab308}
         #painel .status.s-versao{color:#f97316}
         #painel .status.s-req{color:#3b82f6}
         #painel .status.s-ok{color:#166534}
         #painel .status.s-drop{color:#ef4444}
         /* Select de status inline */
         #painel select.status-select{
         border:0;background:transparent;font-weight:600;font-size:14px;padding:0;margin:0;cursor:pointer;color:var(--ink);
         appearance:none;-moz-appearance:none;-webkit-appearance:none;outline:none;height:28px;line-height:28px;
         }
         #painel select.status-select option{ color:var(--ink); }
         /* WhatsApp */
         #painel [data-kind="whatsapp-link"]{
         background:linear-gradient(135deg,#25d366 0%, #128c7e 100%) !important;
         border:1px solid transparent !important; color:#ffffff !important; display:inline-flex; align-items:center; gap:6px;
         border-radius:10px; font-weight:700; font-size:12px; padding:6px 10px; line-height:1;
         }
         #painel [data-kind="whatsapp-link"] .icon{width:16px;height:16px;display:inline-block}
         #painel [data-kind="whatsapp-link"]:hover{filter:brightness(1.05);transform:translateY(-2px);box-shadow:var(--shadow)}
         #painel .btn .icon{width:16px;height:16px;display:inline-block}
         /* Ícones dos botões CSV/Excel */
         #painel .actions #btnExportCsv .icon,
         #painel .actions #btnExportExcel .icon{ width:26px !important; height:26px !important; }
         /* Tamanho fixo nos botões de exportação */
         #painel .actions #btnExportCsv,
         #painel .actions #btnExportExcel{ height:45px !important; padding:8px 16px !important; overflow:hidden !important; }
         /* Trello */
         #painel a[data-kind="trello-link"]{
         background:linear-gradient(135deg,#93c5fd 0%, #60a5fa 100%) !important;
         border:1px solid transparent !important;color:#ffffff !important;display:inline-flex;align-items:center;gap:6px;
         border-radius:10px;font-weight:700;font-size:12px;padding:6px 10px;line-height:1;
         }
         #painel a[data-kind="trello-link"] .icon{width:16px;height:16px;display:inline-block}
         #painel a[data-kind="trello-link"]:hover{filter:brightness(.98);transform:translateY(-2px);box-shadow:var(--shadow)}
         /* ==================== Relatórios ==================== */
         #relatorios .report-actions{
         display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:#fff;padding:16px 24px;
         border:1px solid var(--stroke);border-radius:24px;box-shadow:var(--shadow);margin-bottom:24px
         }
         #relatorios .report-actions .separator{width:1px;height:32px;background:var(--stroke);margin:0 8px}
         #relatorios .report-actions .btn{
         display:inline-flex;align-items:center;gap:8px;height:40px;padding:8px 16px;border-radius:12px;
         font-size:14px;font-weight:600;border:1px solid var(--stroke);
         background:linear-gradient(135deg,var(--stroke-light) 0%,#f8fafc 100%);color:var(--ink);
         cursor:pointer;transition:.2s;box-shadow:var(--shadow-sm);
         }
         #relatorios .report-actions .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
         #relatorios .report-actions .btn img.icon{width:20px;height:20px}
         #relatorios .report-layout{display:flex;gap:24px;align-items:flex-start;margin-top:24px}
         #relatorios .report-sidebar{
         width:350px;background:#fff;padding:24px 20px;border:1px solid var(--stroke);border-radius:24px;box-shadow:var(--shadow);
         }
         #relatorios .report-main{
         flex:1;background:#f8fafc;border:1px solid var(--stroke-light);border-radius:24px;padding:24px;min-height:500px;overflow:auto;
         }
         #relatorios .sidebar-group{margin-bottom:20px}
         #relatorios .sidebar-group label.title{display:block;font-weight:700;margin-bottom:8px}
         #relatorios .sidebar-group .radio-options{
         display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;margin-bottom:8px;width:100%;
         }
         #relatorios .sidebar-group .sub-field{margin-top:8px;display:flex;flex-direction:column;gap:4px}
         #relatorios .filter-adv{margin-bottom:12px;display:flex;flex-direction:column;gap:4px}
         #relatorios .filter-adv .checkbox-label{display:flex;align-items:center;gap:4px;font-weight:600;font-size:14px}
         #relatorios .filter-adv .input, #relatorios .filter-adv select{width:100%}
         #relatorios .report-sidebar input, #relatorios .report-sidebar select{min-width:0}
         /* ===== Modal de confirmação ===== */
         .confirm-modal{
         position:fixed;inset:0;display:none;align-items:center;justify-content:center;
         background:rgba(15,31,28,0.40);backdrop-filter:blur(2px);z-index:9999;padding:16px;
         }
         .confirm__box{
         width:100%;max-width:520px;background:var(--surface);border:1px solid var(--stroke);
         border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);padding:20px;
         }
         .confirm__title{font-weight:700;font-size:18px;margin-bottom:8px;color:var(--ink)}
         .confirm__msg{color:var(--muted);line-height:1.5;margin-bottom:16px}
         .confirm__actions{display:flex;gap:10px;justify-content:flex-end}
         /* Linhas mais finas em reps/usuários */
         #t-reps td, #t-users td{
         vertical-align:middle !important; padding:6px 12px !important; height:36px !important; font-size:14px;
         }
         /* Botão Remover mais compacto */
         #t-reps .btn, #t-users .btn{
         padding:4px 10px !important; height:26px !important; font-size:12px !important; border-radius:8px !important; line-height:1 !important;
         }
         /* ===== Senha (coluna com olhinho) ===== */
         .pwd-cell{ display:inline-flex; align-items:center; gap:8px; }
         .pwd-input{
         width:180px; padding:6px 10px; border:none !important; border-radius:10px;
         background:transparent !important; font-size:12px; color:var(--ink);
         }
         .pwd-input[readonly]{ user-select:all; cursor:default; }
         .btn-eye{
         padding:4px 8px !important; height:26px !important; font-size:12px !important; border-radius:8px !important; line-height:1 !important;
         border:none !important; background:transparent !important; cursor:pointer;
         display:inline-flex; align-items:center; justify-content:center;
         }
         .btn-eye:hover{ background:var(--surface-hover) !important; }
         .eye-icon{ width:16px; height:16px; display:inline-block; }
         /* Célula de ações deve continuar como célula de tabela (evita "risquinho" torto) */
         table td.actions{
         display:table-cell !important;
         vertical-align:middle !important;
         }
         /* Centraliza botões dentro da célula de ações */
         table td.actions .btn{
         display:inline-flex; align-items:center; justify-content:center;
         }
         /* Botão de monitoramento com efeito de pulso quando ligado */
         #painel .btn--live { 
         background: linear-gradient(135deg,#10b981 0%,#059669 100%); 
         color:#fff; 
         border-color:#059669; 
         }
         #painel .btn--live.is-on {
         animation: pulse 2s infinite;
         box-shadow: 0 0 0 4px rgba(16,185,129,.3);
         }
         #painel .btn--live.is-on::after{
         content:'';
         width:8px; height:8px; border-radius:50%;
         background:#10b981; margin-left:6px; display:inline-block;
         box-shadow:0 0 0 0 rgba(16,185,129,.6);
         animation: pulseDot 1.6s infinite;
         }
         @keyframes pulse{
         0%,100%{ box-shadow:0 0 0 4px rgba(248,113,113,.3); }
         50%    { box-shadow:0 0 0 8px rgba(248,113,113,.1); }
         }
         @keyframes pulseDot{ 
         to { box-shadow:0 0 0 10px rgba(248,113,113,.0); } 
         }
         /* ====== A4 REPORT VIEWER ====== */
         #a4-toolbar {
         display:flex; align-items:center; gap:8px; flex-wrap:wrap;
         justify-content:flex-start; margin-bottom:12px;
         }
         #a4-toolbar .btn {
         padding:8px 10px; font-size:12px; border-radius:10px;
         }
         #a4-toolbar .sep { width:1px; height:22px; background:var(--stroke,#e2e8f0); margin:0 4px; }
         #a4-info {
         margin-left:auto; display:flex; gap:12px; font-size:12px; color:var(--muted,#64748b);
         }
         #a4-viewer-wrap {
         --zoom: 1;
         background:transparent;
         display:flex; justify-content:center; align-items:flex-start;
         min-height:420px; /* espaço mínimo do painel */
         overflow:hidden;
         }
         #a4-pages {
         transition: transform .15s ease;
         }
         .a4-page {
         width: 210mm;
         height: 297mm; /* altura fixa A4 */
         background: #fff;
         margin: 0 auto 16px;
         box-shadow: 0 2px 12px rgba(0,0,0,.08);
         border: 1px solid var(--stroke-light,#e2e8f0);
         padding: 18mm 16mm;
         overflow: hidden; /* evita "crescer", forçando quebra por páginas */
         }
         .a4-page[hidden] { display:none; }
         .a4-empty {
         display:flex; align-items:center; justify-content:center;
         min-height: calc(297mm - 36mm);
         color: var(--muted,#64748b);
         text-align:center;
         }
         /* Impressão: mostrar todas as páginas em tamanho real, sem sombras/bordas */
         @media print {
         #a4-toolbar { display:none !important; }
         #a4-viewer-wrap { overflow:visible; }
         .a4-page {
         box-shadow:none; border:0; margin:0 auto; page-break-after: always;
         }
         .a4-page:last-child { page-break-after: auto; }
         }
         /* ====== A4 REPORT – LAYOUT DO RELATÓRIO ====== */
         .rpt-header{
         margin-bottom: 10mm;
         padding: 6mm 6mm 4mm;
         }
         .rpt-header .rpt-title{
         font-size: 20px;
         font-weight: 800;
         text-align: center;
         }
         .rpt-header .rpt-period{
         margin-top: 2mm;
         font-size: 12px;
         text-align: center;
         }
         /* ===== Relatório (analítico e sintético) ===== */
         .rpt-table{
         border-collapse: collapse;
         width:100%;
         border: 1px solid rgba(0,0,0,.55);
         table-layout: fixed;
         }
         .rpt-group-name{ text-align:center; }
         .rpt-table th,
         .rpt-table td{
         border: 1px solid rgba(0,0,0,.55);
         padding: 4px 6px;
         font-size: 12px;
         overflow: hidden;
         text-overflow: ellipsis;
         word-wrap: break-word;
         }
         .rpt-table thead th{
           background: #f3f4f6;
           border-bottom: 1px solid rgba(0,0,0,.7);
         }
         .rpt-table .num{ width:72px; text-align:right; }
         .rpt-table tbody tr:nth-child(odd) td{ background: #fafbff; }
         .rpt-table tbody tr:nth-child(even) td{ background: #ffffff; }
         @media (min-resolution: 2dppx){
           .rpt-table, .rpt-table th, .rpt-table td{ border-width: 1px; }
         }
         @media print{
           .rpt-table, .rpt-table th, .rpt-table td{ border-width: 1px; }
         }
         .rpt-subtotal-inline{
         margin: 6px 0 10px 0;
         font-weight:600;
         font-size: 11px;
         }
         .rpt-total-inline{
         margin-top:8px;
         font-weight:600;
         font-size: 11px;
         }
         .rpt-total-inline.rpt-with-sep{
         border-top:1px solid rgba(0,0,0,.55);
         padding-top:6px;
         }
      </style>
   </head>
   <body>
      <header class="header">
         <h1><span class="first-letter">C</span>onsole <span class="first-letter-admin">A</span>dministrativo</h1>
         <div class="subtitle">Gerencie chamados e usuários em uma única interface</div>
      </header>
      <nav class="tabs" role="tablist">
         <button class="tab" role="tab" aria-selected="true" data-target="#painel">Painel de Chamados</button>
         <button class="tab" role="tab" aria-selected="false" data-target="#cadastro">Cadastro de Usuários</button>
         <!-- Aba de Relatórios adicionada -->
         <button class="tab" role="tab" aria-selected="false" data-target="#relatorios">Relatórios</button>
      </nav>
      <main>
         <section id="painel" class="view active" role="tabpanel" aria-label="Painel de Chamados">
            <div class="filters">
               <div class="filter-group">
                  <label>Representante</label>
                  <select id="fRep" class="select">
                     <option value="">Todos os representantes</option>
                  </select>
               </div>
               <div class="filter-group">
                  <label>Status</label>
                  <select id="fStatus" class="select">
                     <option value="">Todos os status</option>
                     <option>Em aberto</option>
                     <option>Em análise</option>
                     <option>Aguardando versão</option>
                     <option>Aguardando Requisição</option>
                     <option>Finalizado</option>
                     <option>Descartado</option>
                  </select>
               </div>
               <div class="filter-group"><label>Data inicial</label><input id="fDe" type="date" class="input"></div>
               <div class="filter-group"><label>Data final</label><input id="fAte" type="date" class="input"></div>
               <div class="filter-group"><label>Buscar por</label><input id="fQ" class="input" placeholder="Título ou descrição..."></div>
            </div>
            <div class="actions">
               <button class="btn btn--primary" id="btnAplicar">🔍 Aplicar Filtros</button>
               <button class="btn" id="btnLimpar">🧹 Limpar</button>
               <button class="btn btn--live push-right" id="btnRealtime"><span class="dot"></span> Monitoramento em Tempo Real</button>
            </div>
            <div class="count" id="countBox"></div>
            <div class="table-container">
               <div class="table-wrap">
                  <table id="tbl">
                     <thead>
                        <tr>
                           <th>Título</th>
                           <th>Representante</th>
                           <th>Status</th>
                           <th>Detalhes</th>
                           <th>Prioridade</th>
                           <th>Descrição</th>
                           <th>WhatsApp</th>
                           <th>Ações</th>
                        </tr>
                     </thead>
                     <tbody id="tbody">
                        <tr>
                           <td class="empty" colspan="8">
                              <div class="loading"></div>
                              Carregando chamados...
                           </td>
                        </tr>
                     </tbody>
                  </table>
               </div>
            </div>
            <!-- Paginação -->
            <div id="pagination" style="text-align:center;margin:16px 0; display:none;">
               <button class="btn" id="btnMore">Carregar mais</button>
            </div>
            <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
               <div class="modal__box">
                  <h3 class="modal__title" id="modalTitle">Modal</h3>
                  <div class="modal__body" id="modalBody"></div>
                  <div class="modal__actions"><button class="btn" id="btnFecharModal">Fechar</button></div>
               </div>
            </div>
            <audio id="notifSound" src="/static/notify.mp3" preload="auto"></audio>
            
            <!-- Modal de Notificação de Novo Chamado -->
            <div id="notificationModal" class="notification-modal" style="display: none;">
               <div class="notification-content">
                  <div class="notification-icon">🔔</div>
                  <h2 class="notification-title">Novo Chamado!</h2>
                  <p class="notification-message" id="notificationMessage">Um novo chamado foi aberto no Trello</p>
                  <div class="notification-actions">
                     <button class="btn btn--primary" id="notificationOk">OK</button>
                  </div>
               </div>
            </div>
         </section>
         <section id="cadastro" class="view" role="tabpanel" aria-label="Cadastro de Usuários">
            <div class="card">
               <h3>Representantes</h3>
               <form id="form-rep" class="row" onsubmit="return criarRep(event)" style="margin-bottom: 24px;">
                  <input name="name" required placeholder="Nome do novo representante">
                  <button class="btn" type="submit">Adicionar Representante</button>
               </form>
               <div class="table-container">
                  <table id="t-reps">
                     <thead>
                        <tr>
                           <th>Nome</th>
                           <th style="width:140px;">Ações</th>
                        </tr>
                     </thead>
                     <tbody>
                        {% for r in reps %}
                        <tr data-id="{{ r.id }}">
                           <td><strong>{{ r.nome }}</strong></td>
                           <td class="actions">
                              <button class="btn btn--ghost" type="button" onclick="removerRep({{ r.id }})">Remover</button>
                           </td>
                        </tr>
                        {% else %}
                        <tr>
                           <td colspan="2" class="empty-state">Nenhum representante cadastrado</td>
                        </tr>
                        {% endfor %}
                     </tbody>
                  </table>
               </div>
            </div>
            <div class="card">
               <h3>Usuários</h3>
               <form id="form-user" class="row" onsubmit="return criarUser(event)" style="margin-bottom: 24px;">
                  <select name="representative_id" required>
                     <option value="">Selecione o representante</option>
                     {% for r in reps %}
                     <option value="{{ r.id }}">{{ r.nome }}</option>
                     {% endfor %}
                  </select>
                  <input name="username" required placeholder="Nome de usuário"
                     oninput="this.value = this.value.toUpperCase()">
                  <input name="password" type="password" required placeholder="Senha">
                  <button class="btn" type="submit">Adicionar Usuário</button>
               </form>
               <div class="table-container">
                  <table id="t-users">
                     <thead>
                        <tr>
                           <th>Usuário</th>
                           <th>Representante</th>
                           <th>Senha</th>
                           <!-- NOVO -->
                           <th style="width:140px;">Ações</th>
                        </tr>
                     </thead>
                     <tbody>
                        {% for u in users %}
                        <tr data-id="{{ u.id }}">
                           <td><strong>{{ u.username }}</strong></td>
                           <td><span class="pill">{{ u.representative.nome }}</span></td>
                           <td>
                              <div class="pwd-cell">
                                 <input class="pwd-input" type="password" value="{{ u.password or '' }}" readonly>
                                 <button class="btn-eye" type="button" onclick="togglePwd(this)">
                                    <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                       <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                                       <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                 </button>
                              </div>
                           </td>
                           <td class="actions">
                              <button class="btn btn--ghost" type="button" onclick="removerUser({{ u.id }})">Remover</button>
                           </td>
                        </tr>
                        {% else %}
                        <tr>
                           <td colspan="4" class="empty-state">Nenhum usuário cadastrado</td>
                        </tr>
                        {% endfor %}
                     </tbody>
                  </table>
               </div>
            </div>
         </section>
         <!-- ===================== Aba de Relatórios ===================== -->
         <section id="relatorios" class="view" role="tabpanel" aria-label="Relatórios">
            <!-- Barra de ações do relatório -->
            <div class="report-actions">
               <button class="btn" id="btnPdfRel" aria-label="Exportar relatório em PDF">
               <span class="icon" aria-hidden="true">📄</span> PDF
               </button>
               <button class="btn" id="btnCsvRel" aria-label="Exportar relatório em CSV">
               <span class="icon" aria-hidden="true">🧾</span> CSV
               </button>
               <button class="btn" id="btnXlsRel" aria-label="Exportar relatório em XLSX">
               <span class="icon" aria-hidden="true">📊</span> XLSX
               </button>
               <button class="btn" id="btnPrintRel" aria-label="Imprimir relatório">
               <span class="icon" aria-hidden="true">🖨️</span> Imprimir
               </button>
               <button class="btn" id="btnEmailRel" aria-label="Enviar relatório por e-mail">
               <span class="icon" aria-hidden="true">✉️</span> E-mail
               </button>
               <div class="separator"></div>
               <button class="btn" id="btnZoomInRel" aria-label="Aumentar zoom">
               <span class="icon" aria-hidden="true">➕</span> Zoom
               </button>
               <button class="btn" id="btnZoomOutRel" aria-label="Diminuir zoom">
               <span class="icon" aria-hidden="true">➖</span> Zoom
               </button>
               <div class="separator"></div>
               <button class="btn" id="btnFirstPageRel" aria-label="Primeira página">
               <span class="icon" aria-hidden="true">⏮️</span>
               </button>
               <button class="btn" id="btnPrevPageRel" aria-label="Página anterior">
               <span class="icon" aria-hidden="true">⏪</span>
               </button>
               <button class="btn" id="btnNextPageRel" aria-label="Próxima página">
               <span class="icon" aria-hidden="true">⏩</span>
               </button>
               <button class="btn" id="btnLastPageRel" aria-label="Última página">
               <span class="icon" aria-hidden="true">⏭️</span>
               </button>
            </div>
            <div id="a4-info" style="margin-left:auto; font-size:13px; font-weight:600; display:flex; gap:12px; align-items:center;">
               <span id="a4-page-info">Página 1/1</span>
               <span id="a4-zoom-info">100%</span>
            </div>
            <!-- Layout: painel de filtros lateral + área de visualização -->
            <div class="report-layout">
               <!-- Painel lateral de filtros -->
               <div class="report-sidebar">
                  <!-- Cabeçalho opcional -->
                  <h3 style="margin-bottom:16px;font-weight:700;font-size:18px;">Curva ABC de Chamados</h3>
                  <!-- Período -->
                  <div class="sidebar-group">
                     <label class="title">Período</label>
                     <div class="sub-field">
                        <label style="font-weight:600;font-size:13px;margin-bottom:2px;">Inicial</label>
                        <input id="relInicio" type="date" class="input">
                     </div>
                     <div class="sub-field" style="margin-top:8px;">
                        <label style="font-weight:600;font-size:13px;margin-bottom:2px;">Fim</label>
                        <input id="relFim" type="date" class="input">
                     </div>
                  </div>
                  <!-- Tipo de Relatório -->
                  <div class="sidebar-group">
                     <label class="title">Tipo de Relatório:</label>
                     <div class="radio-options">
                        <label><input type="radio" name="tipoRelatorio" value="sintetico" checked> Sintético</label>
                        <label><input type="radio" name="tipoRelatorio" value="analitico"> Analítico</label>
                     </div>
                  </div>
                  <!-- Agrupar por -->
                  <div class="sidebar-group">
                     <label class="title">Agrupar por:</label>
                     <div class="radio-options">
                        <label><input type="radio" name="agruparPor" value="cliente" checked> Cliente</label>
                        <label><input type="radio" name="agruparPor" value="representante"> Representante</label>
                     </div>
                  </div>
                  <!-- Tipo de Chamado -->
                  <div class="sidebar-group">
                     <label class="title">Tipo de Chamado:</label>
                     <div class="radio-options">
                        <label><input type="radio" name="tipoChamado" value="todos" checked> Todos</label>
                        <label><input type="radio" name="tipoChamado" value="duvida"> Dúvida</label>
                        <label><input type="radio" name="tipoChamado" value="melhoria"> Melhoria</label>
                        <label><input type="radio" name="tipoChamado" value="bug"> Bug</label>
                     </div>
                  </div>
                  <!-- Filtros adicionais -->
                  <div class="sidebar-group">
                     <div class="filter-adv">
                        <label class="checkbox-label"><input type="checkbox" id="chkClienteRel"> Cliente</label>
                        <input id="fClienteRel" type="text" class="input" placeholder="Nome do cliente" disabled>
                     </div>
                     <div class="filter-adv">
                        <label class="checkbox-label"><input type="checkbox" id="chkRepresentanteRel"> Representante</label>
                        <select id="fRepresentanteRel" class="input" disabled>
                           <option value="">Selecione...</option>
                        </select>
                     </div>
                     <div class="filter-adv">
                        <label class="checkbox-label"><input type="checkbox" id="chkSistemaRel"> Sistema</label>
                        <select id="fSistemaRel" class="input" disabled>
                           <option value="">Selecione...</option>
                        </select>
                     </div>
                     <div class="filter-adv">
                        <label class="checkbox-label"><input type="checkbox" id="chkModuloRel"> Módulo</label>
                        <select id="fModuloRel" class="input" disabled>
                           <option value="">Selecione...</option>
                        </select>
                     </div>
                     <div class="filter-adv">
                        <label class="checkbox-label"><input type="checkbox" id="chkOcorrenciaRel"> Ocorrência</label>
                        <select id="fOcorrenciaRel" class="input" disabled>
                           <option value="">Selecione...</option>
                        </select>
                     </div>
                  </div>
                  <div style="margin-top:24px; text-align:right;">
                     <button class="btn btn--primary" id="btnConfirmarRel">Confirmar</button>
                  </div>
               </div>
               <!-- Área principal onde o relatório será exibido -->
               <div class="report-main">
                  <!-- Viewer A4 -->
                  <div id="a4-viewer-wrap">
                     <div id="a4-pages"></div>
                  </div>
               </div>
            </div>
         </section>
      </main>
      <!-- ===== Helpers separados (fora de qualquer <script> aninhado) ===== -->
      <script>
         // Modal helpers
         let __timerId = null;
         function openModal(title, html) {
         const modal = document.getElementById('modal');
         const modalTitle = document.getElementById('modalTitle');
         const modalBody = document.getElementById('modalBody');
         // Limpeza mais robusta do timer
         if (window.__timerId) { 
         clearInterval(window.__timerId); 
         window.__timerId = null; 
         }
           modalTitle.textContent = title;
           modalBody.innerHTML = html;
           modal.style.display = 'flex';
         }
         function closeModal(){
         const modal = document.getElementById('modal');
         // Garantir limpeza do timer ao fechar
         if (window.__timerId) { 
         clearInterval(window.__timerId); 
         window.__timerId = null; 
         }
         modal.style.display = 'none';
         }
         window.openModal = openModal;
         window.closeModal = closeModal;
         document.getElementById('btnFecharModal')?.addEventListener('click', closeModal);
         document.getElementById('modal')?.addEventListener('click', (e)=>{ if (e.target.id==='modal') closeModal(); });
         
         // Durations
         function fmtDur(ms){
           ms = Math.max(0, ms|0);
           const s = Math.floor(ms/1000);
           const hh = String(Math.floor(s/3600)).padStart(2,'0');
           const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
           const ss = String(s%60).padStart(2,'0');
           return `${hh}:${mm}:${ss}`;
         }
         function inferCreatedAt(item){
           if (item && item.id && /^[0-9a-f]{24}$/i.test(item.id)) {
             const secs = parseInt(item.id.substring(0,8), 16);
             if (!Number.isNaN(secs)) return new Date(secs * 1000);
           }
           if (item && item.created_at) return new Date(item.created_at);
           if (item && item.ultima_atividade) { try { return new Date(item.ultima_atividade); } catch(e){} }
           return null;
         }
         window.inferCreatedAt = inferCreatedAt;
         
         // WhatsApp helpers (app desktop)
         function normalizeBRPhone(raw){
           let n = String(raw || '').replace(/\D/g, '');
           n = n.replace(/^55+/, '');
           return '55' + n;
         }
         function openWhatsApp(rawPhone, text){
           console.log('📱 Abrindo WhatsApp para:', rawPhone);
           const phone = normalizeBRPhone(rawPhone);
           const q = text ? ('&text=' + encodeURIComponent(text)) : '';
           const deepLink = 'whatsapp://send?phone=' + phone + q;
           console.log('🔗 Link do WhatsApp:', deepLink);

// Abre o app via protocolo do WhatsApp; não cria nova aba do navegador
         window.location.href = deepLink;
         }
         window.openWhatsApp = openWhatsApp;
         
         // Image Viewer
         function openImageViewer(images, currentIndex) {
           console.log('🖼️ Abrindo visualizador de imagens:', { images, currentIndex });
           
           // Criar overlay do visualizador
           const overlay = document.createElement('div');
           overlay.id = 'imageViewerOverlay';
           overlay.style.cssText = `
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.96);
             z-index: 10000;
             display: flex;
             align-items: center;
             justify-content: center;
             flex-direction: column;
             backdrop-filter: blur(8px);
             animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
             overscroll-behavior: contain;
           `;
           
           // Adicionar animação CSS
           if (!document.getElementById('imageViewerStyles')) {
             const style = document.createElement('style');
             style.id = 'imageViewerStyles';
             style.textContent = `
               @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
               @keyframes slideIn { from { transform: scale(0.85) translateY(30px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
               @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
               .viewer-image { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
               .viewer-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
               .viewer-btn:hover { transform: scale(1.05); background: rgba(255,255,255,1) !important; box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important; }
               .viewer-btn:active { transform: scale(0.95); }
               @media (max-width: 768px) {
                 .viewer-nav-btn { width: 50px !important; height: 50px !important; font-size: 24px !important; }
                 .viewer-close-btn { width: 45px !important; height: 45px !important; font-size: 20px !important; }
                 .viewer-info { padding: 12px 20px !important; font-size: 14px !important; }
               }
               @media (max-width: 480px) {
                 .viewer-nav-btn { width: 45px !important; height: 45px !important; font-size: 20px !important; }
                 .viewer-close-btn { width: 40px !important; height: 40px !important; font-size: 18px !important; }
                 .viewer-info { padding: 10px 16px !important; font-size: 13px !important; }
               }
             `;
             document.head.appendChild(style);
           }
           
           let currentIdx = currentIndex || 0;
           
           function updateImage() {
             const img = images[currentIdx];
             // Usar a melhor qualidade disponível: primeiro tenta previews maiores, depois URL original
             let imageUrl = img.url;
             if (img.previews && img.previews.length > 0) {
               // Procura o preview de maior resolução disponível
               const sortedPreviews = img.previews.sort((a, b) => (b.width || 0) - (a.width || 0));
               imageUrl = sortedPreviews[0].url || img.url;
             }
             
             overlay.innerHTML = `
                 <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 15px; box-sizing: border-box;">
                   <div id="imageContainer" style="position: relative; display: flex; align-items: center; justify-content: center; min-height: 200px;">
                     <div id="imageLoader" style="color: white; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                       <div style="width: 20px; height: 20px; border: 2px solid #ffffff40; border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                       Carregando imagem...
                     </div>
                     <img id="viewerImage" src="${imageUrl}" alt="${img.name}" 
                          class="viewer-image"
                          style="max-width: 92vw; max-height: 80vh; width: auto; height: auto; border-radius: 16px; box-shadow: 0 12px 50px rgba(0,0,0,0.7); display: none; object-fit: contain; user-select: none;"
                          onload="document.getElementById('imageLoader').style.display='none'; this.style.display='block';"
                          onerror="document.getElementById('imageLoader').innerHTML='❌ Erro ao carregar imagem'; document.getElementById('imageLoader').style.color='#ff6b6b';">
                   </div>
                 
                 ${images.length > 1 ? `
                   <button id="prevBtn" class="viewer-btn viewer-nav-btn" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.95); border: none; border-radius: 50%; width: 65px; height: 65px; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 25px rgba(0,0,0,0.4); z-index: 10001; font-weight: bold; color: #1f2937; backdrop-filter: blur(10px);" ${currentIdx === 0 ? 'disabled style="opacity: 0.4; cursor: not-allowed; transform: translateY(-50%) scale(0.9);"' : ''}>‹</button>
                   <button id="nextBtn" class="viewer-btn viewer-nav-btn" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.95); border: none; border-radius: 50%; width: 65px; height: 65px; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 25px rgba(0,0,0,0.4); z-index: 10001; font-weight: bold; color: #1f2937; backdrop-filter: blur(10px);" ${currentIdx === images.length - 1 ? 'disabled style="opacity: 0.4; cursor: not-allowed; transform: translateY(-50%) scale(0.9);"' : ''}>›</button>
                 ` : ''}
               </div>
               
               <div class="viewer-info" style="position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); text-align: center; color: white; background: rgba(0,0,0,0.8); padding: 16px 30px; border-radius: 30px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); max-width: 90vw; box-sizing: border-box;">
                 <h3 style="margin: 0 0 6px 0; font-size: 16px; font-weight: 700; line-height: 1.3; word-break: break-word;">${img.name}</h3>
                 <p style="margin: 0; opacity: 0.85; font-size: 13px; color: #e2e8f0; font-weight: 500;">${currentIdx + 1} de ${images.length} imagens</p>
               </div>
               
               <button id="closeViewer" class="viewer-btn viewer-close-btn" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.95); border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 26px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 25px rgba(0,0,0,0.4); z-index: 10001; font-weight: bold; color: #1f2937; backdrop-filter: blur(10px);">×</button>
             `;
             
             // Event listeners
             const closeBtn = overlay.querySelector('#closeViewer');
             closeBtn?.addEventListener('click', () => {
               document.body.removeChild(overlay);
             });
             
             if (images.length > 1) {
               const prevBtn = overlay.querySelector('#prevBtn');
               const nextBtn = overlay.querySelector('#nextBtn');
               
               prevBtn?.addEventListener('click', () => {
                 if (currentIdx > 0) {
                   currentIdx--;
                   updateImage();
                 }
               });
               
               nextBtn?.addEventListener('click', () => {
                 if (currentIdx < images.length - 1) {
                   currentIdx++;
                   updateImage();
                 }
               });
             }
           }
           
           // Fechar com ESC ou clique no fundo
           overlay.addEventListener('click', (e) => {
             if (e.target === overlay) {
               document.body.removeChild(overlay);
             }
           });
           
           document.addEventListener('keydown', function escHandler(e) {
             if (e.key === 'Escape') {
               document.body.removeChild(overlay);
               document.removeEventListener('keydown', escHandler);
             } else if (e.key === 'ArrowLeft' && currentIdx > 0) {
               currentIdx--;
               updateImage();
             } else if (e.key === 'ArrowRight' && currentIdx < images.length - 1) {
               currentIdx++;
               updateImage();
             }
           });
           
           updateImage();
           document.body.appendChild(overlay);
         }
         window.openImageViewer = openImageViewer;
         
         
      </script>
      <!-- ===== App principal ===== -->
      <script>
         (function checkServiceWorker(){
         const params = new URLSearchParams(location.search);
         if(params.get('nosw') === '1' && 'serviceWorker' in navigator){
           navigator.serviceWorker.getRegistrations().then(function(registrations) {
             for(let registration of registrations) {
               registration.unregister().then(() => {
                 console.log('🧹 Service Worker removido');
                 location.replace(location.pathname + location.search.replace(/[?&]nosw=1/, ''));
               });
             }
           });
         }
         })();
           // Tabs
           const tabs = document.querySelectorAll('.tab');
           tabs.forEach(btn => btn.addEventListener('click', () => {
             tabs.forEach(b => b.setAttribute('aria-selected','false'));
             document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
             btn.setAttribute('aria-selected','true');
             document.querySelector(btn.dataset.target).classList.add('active');
           }));
         
           (function initPainel(){
             const painel = document.getElementById('painel');
             if(!painel) return;
         
             const tbody = painel.querySelector('#tbody');
             const countBox = painel.querySelector('#countBox');
             const repSelect = painel.querySelector('#fRep');
             const statusSelect = painel.querySelector('#fStatus');
             const deInput = painel.querySelector('#fDe');
             const ateInput = painel.querySelector('#fAte');
             const qInput = painel.querySelector('#fQ');
             const btnRealtime = painel.querySelector('#btnRealtime');
             const btnAplicar = painel.querySelector('#btnAplicar');
             const btnLimpar = painel.querySelector('#btnLimpar');
             const btnMore = document.getElementById('btnMore');
             const pagination = document.getElementById('pagination');
         
             // Paginação e status
             let page = 0;
             const pageSize = 50;
             let totalItems = 0;
             // Opções de status para alteração
             const STATUS_OPTIONS = ['Em aberto','Em análise','Aguardando versão','Aguardando Requisição','Finalizado','Descartado'];
         
             const LIVE_SET = new Set(['em aberto','em análise']);
         
             const esc = s => String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
             const statusClass = (s) => {
               const m = (s||'').toLowerCase();
               if (m.includes('em aberto')) return 'status s-open';
               if (m.includes('análise') || m.includes('analise')) return 'status s-analise';
               if (m.includes('versão') || m.includes('versao')) return 'status s-versao';
               if (m.includes('abrir requisição') || m.includes('abrir requisicao') ||
                   m.includes('aguardando requisição') || m.includes('aguardando requisicao') ||
                   m.includes('requisição') || m.includes('requisicao')) return 'status s-req';
               if (m.includes('finalizado') || m.includes('resolvido') || m.includes('resolvidos')) return 'status s-ok';
               if (m.includes('descart')) return 'status s-drop';
               return 'status';
             };
         
             // Cor (hex) de cada status. Utilizado para colorir o <select> na coluna de status.
             const statusColor = (s) => {
               const m = (s || '').toLowerCase();
               if (m.includes('em aberto')) return '#22c55e';
               if (m.includes('análise') || m.includes('analise')) return '#eab308';
               if (m.includes('versão') || m.includes('versao')) return '#f97316';
               if (m.includes('abrir requisição') || m.includes('abrir requisicao') ||
                   m.includes('aguardando requisição') || m.includes('aguardando requisicao') ||
                   m.includes('requisição') || m.includes('requisicao')) return '#3b82f6';
               if (m.includes('finalizado') || m.includes('resolvido') || m.includes('resolvidos')) return '#166534';
               if (m.includes('descart')) return '#ef4444';
               // padrão: cor principal
               return 'var(--ink)';
             };
         
            // Cor de cada prioridade. Utilizado para colorir a coluna de prioridade.
            const priorityColor = (p) => {
              const m = (p || '').toLowerCase();
              if (m.includes('alta')) return '#e74c3c';
              if (m.includes('média') || m.includes('media')) return '#eab308';
              if (m.includes('baixa')) return '#22c55e';
              return 'var(--ink)';
            };
          
          function applyStatusSelectColors(rootEl){
           (rootEl || document).querySelectorAll('select.status-select').forEach(sel=>{
             sel.style.color = statusColor(sel.value);
           });
         }
          
             const parsePriority = (desc) => {
               const m = (desc||'').match(/\*\*Prioridade:\*\*\s*([^\n]+)/i);
               return m ? m[1].trim() : '-';
             };
         
             // Controle de cache e estado
             let cache = []; let lastKeys = new Set();
             let isRealTimeActive = false;
             let realTimeInterval = null;
         let isEditingStatus = false;
         let pendingRenderData = null;
         
             // Cancelamento de chamadas pendentes
             let abortController = null;
             let latestLoadId = 0;
         
             // Fonte para conexões SSE
             let realtimeSource = null;
         
            // -- Integração Trello --
            // Mantém o timestamp da última verificação de cartões no Trello.  Esse valor será
            // enviado como parâmetro `since` para que o servidor retorne apenas os cartões
            // criados após esse horário. Ajuste o endpoint `/api/trello/new-cards` no backend
            // para lidar com esse parâmetro e retornar um array de cartões novos.
            let lastTrelloCheck = new Date().toISOString();
         
            /**
             * Busca cartões recém‑criados no Trello desde o momento em que lastTrelloCheck foi
             * atualizado. Essa função envia um fetch para `/api/trello/new-cards?since=...`
             * que deve ser implementado no seu backend com a lógica de consultar a API do Trello.
             * Ao receber uma lista de cartões, você pode inserir cada novo cartão na tabela
             * ou emitir alguma notificação. Esta implementação não altera a UI diretamente,
             * ficando a cargo do desenvolvedor tratar os resultados retornados.
             */
            async function fetchNewTrelloCards() {
              try {
                const url = '/api/trello/new-cards?since=' + encodeURIComponent(lastTrelloCheck);
                const response = await fetch(url, { credentials: 'same-origin', cache: 'no-store' });
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (Array.isArray(data) && data.length) {
                  // Mostra notificação para cada novo cartão
                  data.forEach(card => {
                    showNewTicketNotification(card);
                  });
                  console.log('📦 Novos cartões Trello recebidos:', data);
                }
                // Atualiza o timestamp para a próxima consulta
                lastTrelloCheck = new Date().toISOString();
              } catch (err) {
                console.warn('Erro ao buscar cartões do Trello:', err);
              }
            }
            
            /**
             * Mostra notificação chamativa para novo chamado
             */
            function showNewTicketNotification(card) {
              // Toca o som de notificação
              const audio = document.getElementById('notifSound');
              if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.warn('Erro ao tocar som:', e));
              }
              
              // Solicita permissão para notificação do navegador (backup)
              if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
              }
              
              // Mostra notificação do navegador se permitido
              if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Novo Chamado!', {
                  body: `Cliente: ${card.cliente || 'N/A'}\nRepresentante: ${card.representante || 'N/A'}`,
                  icon: '/static/trello.png',
                  tag: 'new-ticket',
                  requireInteraction: true
                });
              }
              
              // Mostra modal centralizado
              const modal = document.getElementById('notificationModal');
              const message = document.getElementById('notificationMessage');
              
              // Formata as informações do chamado com quebras de linha HTML
              const cardInfo = `<strong>Cliente:</strong> ${card.cliente || 'N/A'}<br>
                               <strong>Representante:</strong> ${card.representante || 'N/A'}<br>
                               <strong>Sistema:</strong> ${card.sistema || 'N/A'}`;
              
              // Usa innerHTML para preservar as tags HTML
              message.innerHTML = cardInfo;
              modal.style.display = 'flex';
              
              // Remove notificação anterior se existir
              if (window.activeNotification) {
                window.activeNotification.close();
              }
              
              // Cria uma notificação persistente que, quando clicada, foca na janela
              if ('Notification' in window && Notification.permission === 'granted') {
                // Formata o texto da notificação para melhor legibilidade
                const notificationBody = [
                  `Cliente: ${card.cliente || 'N/A'}`,
                  `Representante: ${card.representante || 'N/A'}`,
                  `Sistema: ${card.sistema || 'N/A'}`,
                  ``,
                  `Clique para abrir o painel`
                ].join('\n');
                
                const notification = new Notification('Novo Chamado!', {
                  body: notificationBody,
                  icon: '/static/trello.png',
                  requireInteraction: true, // Mantém a notificação até o usuário interagir
                  tag: 'new-ticket-' + Date.now() // Tag única para cada notificação
                });
                
                // Armazena a notificação ativa para referência
                window.activeNotification = notification;
                
                notification.onclick = function() {
                  // Foca na janela quando a notificação é clicada
                  window.focus();
                  modal.style.display = 'flex'; // Garante que o modal está visível
                  this.close();
                };
              }
              
              // Tenta focar na janela (pode não funcionar se minimizada)
              try {
                window.focus();
              } catch (e) {
                console.log('Não foi possível focar na janela, mas a notificação foi exibida');
              }
              
              // Adiciona evento de fechamento
              const okBtn = document.getElementById('notificationOk');
              okBtn.onclick = () => {
                modal.style.display = 'none';
              };
              
              // Não fecha automaticamente - permanece aberto até o usuário fechar
              // O fechamento automático foi removido a pedido do usuário
            }
            
            /**
             * Função de teste para notificação (remover em produção)
             * Chame showNewTicketNotificationTest() no console para testar
             */
            function showNewTicketNotificationTest() {
              console.log('🔔 Testando notificação de novo chamado...');
              requestNotificationPermission(); // Garante que a permissão foi solicitada
              
              const testCard = {
                cliente: 'Cliente Teste com Nome Longo para Testar Formatação',
                representante: 'João Silva - Representante Comercial',
                sistema: 'Sistema ERP - Módulo Financeiro'
              };
              showNewTicketNotification(testCard);
            }
            
            /**
             * Função de teste para simular um novo chamado vindo da API
             * Chame testApiNotification() no console para testar
             */
            function testApiNotification() {
              console.log('🔔 Testando notificação com formato da API...');
              requestNotificationPermission(); // Garante que a permissão foi solicitada
              
              // Simula o formato exato que vem da API
              const testCard = {
                id: 'test123',
                titulo: 'Chamado de Teste API',
                descricao: '**Cliente:** Cliente API Teste\n**Representante:** Rep API Teste\n**Sistema:** Sistema API Teste',
                cliente: 'Cliente API Teste',  // Campo adicionado na API
                representante: 'Rep API Teste', // Campo adicionado na API
                sistema: 'Sistema API Teste',   // Campo adicionado na API
                lista: 'Em Andamento',
                status: 'Em andamento',
                url: '#',
                ultima_atividade: new Date().toISOString(),
                created_at: new Date().toISOString()
              };
              
              console.log('Dados do cartão de teste:', testCard);
              showNewTicketNotification(testCard);
            }
            
            /**
             * Função de teste para verificar se o monitoramento de novos chamados está funcionando
             * independentemente do monitoramento em tempo real
             */
            function testNewTicketsMonitoring() {
              console.log('🧪 Testando monitoramento de novos chamados...');
              console.log('Status do monitoramento em tempo real:', isRealTimeActive ? 'ATIVO' : 'INATIVO');
              console.log('Intervalo de novos chamados:', newTicketsInterval ? 'ATIVO' : 'INATIVO');
              
              // Simula a chegada de um novo chamado
              const testCard = {
                cliente: 'Cliente Teste Monitoramento',
                representante: 'Teste Independente',
                sistema: 'Sistema Teste'
              };
              
              // Mostra a notificação diretamente
              showNewTicketNotification(testCard);
              
              console.log('✅ Teste concluído. Uma notificação deve ter sido exibida.');
              console.log('👉 Este teste simula apenas a exibição da notificação, não a detecção de novos chamados.');
              console.log('👉 Para testar a detecção completa, é necessário criar um novo chamado no Trello.');
            }
            
            // Disponibiliza funções de teste globalmente
            window.testNotification = showNewTicketNotificationTest;
            window.testNewTicketsMonitoring = testNewTicketsMonitoring;
         
             /**
              * Encerra qualquer monitoramento em tempo real (SSE ou poll) e aborta requisições pendentes.
              * Não afeta o monitoramento de novos chamados.
              */
             function cleanupRealTime(){
         console.log('🧹 Iniciando cleanup do monitoramento em tempo real...');
         
         // Fecha SSE se aberto
         if(realtimeSource){
         try { 
         realtimeSource.close(); 
         console.log('✅ SSE fechado');
         } catch(e){
         console.warn('⚠️ Erro ao fechar SSE:', e);
         }
         realtimeSource = null;
         }
         
         // Cancela intervalo de fallback
         if(realTimeInterval){
         clearInterval(realTimeInterval);
         realTimeInterval = null;
         console.log('✅ Polling interrompido');
         }
         
         // Aborta fetch pendente
         if(abortController){
         try { 
         abortController.abort(); 
         console.log('Fetch anterior abortado');
         } catch(e){}
         abortController = null;
         }
         // Nota: Não interrompe o monitoramento de novos chamados (newTicketsInterval)
         }
         window.cleanupRealTime = cleanupRealTime;
         
         
            // Variável para controlar o intervalo de verificação de novos chamados
            let newTicketsInterval = null;
            
            /**
             * Inicia o monitoramento de novos chamados independente do monitoramento em tempo real
             */
            function startNewTicketsMonitoring() {
              // Limpa qualquer intervalo anterior
              if (newTicketsInterval) {
                clearInterval(newTicketsInterval);
              }
              
              // Inicia um novo intervalo para verificar novos chamados a cada 10 segundos
              newTicketsInterval = setInterval(() => {
                fetchNewTrelloCards?.();
              }, 10000);
              
              console.log('✅ Monitoramento de novos chamados iniciado');
            }
            
            /**
             * Solicita permissão para notificações do navegador
             */
            function requestNotificationPermission() {
                if ('Notification' in window) {
                    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                        Notification.requestPermission().then(function(permission) {
                            if (permission === 'granted') {
                                console.log('✅ Permissão para notificações concedida!');
                            }
                        });
                    }
                }
            }
            
            // Inicia o monitoramento de novos chamados ao carregar a página
            document.addEventListener('DOMContentLoaded', () => {
              // Solicita permissão para notificações ao carregar a página
              requestNotificationPermission();
              // Inicia o monitoramento de novos tickets
              startNewTicketsMonitoring();
            });
            
            // Para o monitoramento de novos chamados quando a página for fechada
            window.addEventListener('beforeunload', () => {
              if (newTicketsInterval) {
                clearInterval(newTicketsInterval);
                newTicketsInterval = null;
                console.log('✅ Monitoramento de novos chamados interrompido');
              }
            });
            
            /**
             * Função para testar notificação com janela minimizada
             * Chame testNotificationMinimized() no console do navegador
             */
            function testNotificationMinimized() {
              console.log('🔔 Testando notificação com janela minimizada...');
              console.log('Minimize a janela agora e aguarde 3 segundos para a notificação aparecer');
              
              // Garante que a permissão foi solicitada
              requestNotificationPermission();
              
              // Aguarda 3 segundos e então mostra a notificação
              setTimeout(() => {
                const testCard = {
                  cliente: 'Cliente Teste Minimizado',
                  representante: 'Teste Minimizado',
                  sistema: 'Sistema de Teste'
                };
                showNewTicketNotification(testCard);
              }, 3000);
            }
            
            // Torna a função disponível globalmente
            window.testNotificationMinimized = testNotificationMinimized;
            
            /**
             * Alterna o monitoramento em tempo real.
             * Esta versão replica a lógica do console_antigo.html utilizando um simples
             * polling a cada 6 segundos em vez de SSE. Ao ativar, força o filtro
             * "Em aberto", reinicia a página e inicia o intervalo. Ao desativar,
             * encerra o intervalo e recarrega os dados com os filtros atuais.
             */
            async function toggleRealTime(){
         console.log('🔄 Toggle realtime:', !isRealTimeActive);
         
         if (!isRealTimeActive) {
         // ===== ATIVANDO =====
         isRealTimeActive = true;
         
         // força "Em aberto" (sem mexer nos outros filtros visuais)
         try {
         statusSelect.value = 'Em aberto';
         if (typeof applyStatusSelectColors === 'function') applyStatusSelectColors();
         } catch(e){}
         
         btnRealtime.classList.add('is-on');
         btnRealtime.textContent = '⏹ Parar Monitoramento';
         
         // limpa qualquer conexão/poll anterior
         cleanupRealTime();
         
         // Aplica o filtro imediatamente após definir "Em aberto"
         console.log('🔄 Aplicando filtro "Em aberto" e recarregando dados...');
         page = 0; // Reset da paginação para aplicar o filtro corretamente
         cache = []; // Limpa o cache para forçar nova busca com filtro
         
         // Carrega os dados com o novo filtro aplicado
         await load({ silent: false, append: false });
         
         // inicia o polling leve (a cada 2,5s). Só recarrega se NÃO estiver editando status
         if (isRealTimeActive) {
         console.log('✅ Iniciando monitoramento em tempo real...');
         realTimeInterval = setInterval(() => {
          if (!isEditingStatus) {
            console.log('🔄 Polling automático - atualizando dados...');
            load({ silent: true, append: false });
            // Não precisamos chamar fetchNewTrelloCards aqui, pois já temos um intervalo separado para isso
          }
         }, 2500);
         }
         
         } else {
         // ===== DESATIVANDO =====
         isRealTimeActive = false;
         
         btnRealtime.classList.remove('is-on');
         btnRealtime.innerHTML = '<span class="dot"></span> Monitoramento em Tempo Real';
         
         // 1) para polling/SSE/fetch
         cleanupRealTime();
         
         // 2) pequena pausa para garantir que nenhum fetch abortado "vaze"
         await new Promise(r => setTimeout(r, 50));
         
         // 3) recarrega respeitando os filtros atuais (sem forçar "Em aberto")
         try {
         await load({ silent: false });
         console.log('✅ Monitoramento desativado e dados recarregados');
         } catch (err) {
         console.error('Erro ao recarregar após desativar:', err);
         }
         }
         }
         
         
         
         function startSSEConnection(){
         if(!isRealTimeActive) return;
         
         let reconnectAttempts = 0; // Declarar no escopo da função principal
         
         const handleSSEMessage = function(ev){
         try {
         const data = JSON.parse(ev.data || '{}');
         if(data && data.update){
         load({silent:true});
         }
         } catch(err){}
         };
         
         const reconnectSSE = function(){
         if(!isRealTimeActive) return;
         
         try {
         if(realtimeSource) {
         realtimeSource.close();
         realtimeSource = null;
         }
         
         realtimeSource = new EventSource('/api/chamados/stream');
         
         realtimeSource.onopen = function(){
         console.log('✅ SSE conectado');
         reconnectAttempts = 0; // Reset contador quando conecta com sucesso
         };
         
         realtimeSource.onmessage = handleSSEMessage;
         
         realtimeSource.onerror = function(err){
         console.warn('Erro no SSE:', err);
         if(realtimeSource) {
          realtimeSource.close();
          realtimeSource = null;
         }
         
         if(isRealTimeActive) {
          reconnectAttempts++;
          const delay = Math.min(Math.pow(2, reconnectAttempts) * 5000, 60000);
          setTimeout(() => {
            if(isRealTimeActive) {
              reconnectSSE();
            }
          }, delay);
         }
         };
         
         } catch(e) {
         console.warn('Falha ao criar SSE:', e);
         if(!realTimeInterval && isRealTimeActive) {
         realTimeInterval = setInterval(() => {
          if(isRealTimeActive) load({silent:true});
         }, 30000);
         }
         }
         };
         
         reconnectSSE(); // Iniciar a primeira conexão
         }
             // Conecta evento do botão
             btnRealtime.addEventListener('click', toggleRealTime);
         
             function buildRowHTML(it,i){
               const prio = it.prioridade || parsePriority(it.descricao);
               const trelloLink = it.url ? (`
                 <a data-kind="trello-link" class="btn" href="${esc(it.url)}" target="_blank" rel="noopener">
                   <img src="/static/trello.png" alt="Trello" class="icon"> Trello
                 </a>`) : '-';
         
               let whatsappLink = '-';
               if (it.whatsapp && String(it.whatsapp).replace(/\D/g,'').length >= 8) {
                 const phoneEsc = String(it.whatsapp).replace(/'/g, "\\'");
                 const onClick = `openWhatsApp('${phoneEsc}')`;
                 whatsappLink = `<button data-kind="whatsapp-link" class="btn" type="button" onclick="${onClick}">
                   <img src="/static/whatsapp.png" alt="WhatsApp" class="icon"> WhatsApp
                 </button>`;
               }
         
               // Select para mudar status (agora dentro da própria coluna de status)
               const statusOptions = STATUS_OPTIONS.map(opt => {
                 const selected = opt === it.status ? ' selected' : '';
                 return `<option value="${esc(opt)}"${selected}>${esc(opt)}</option>`;
               }).join('');
               // Cor do status para o select
               const statusCol = statusColor(it.status);
               const statusSelect = `<select class="status-select" data-id="${esc(it.id||'')}" style="color:${statusCol}">${statusOptions}</select>`;
               // Ações: apenas botão do Trello (aplica estilos via CSS .actions)
               const actionsHtml = `<div class="actions">${trelloLink}</div>`;
         
               const prioCol = priorityColor(prio);
               return (
                 '<tr data-key="'+esc(it.id || it.url || it.titulo || String(i))+'">'+
                   '<td class="title" title="'+esc(it.titulo)+'">'+esc(it.titulo)+'</td>'+ 
                   '<td>'+esc(it.representante||"-")+'</td>'+
                   // Coluna de status contém o <select>
                   '<td>'+statusSelect+'</td>'+ 
                   '<td><button class="btn btn--ghost" data-i="'+i+'" data-action="detalhes">📋 Detalhes</button></td>'+ 
                   '<td class="prio" style="color:'+prioCol+'">'+esc(prio||"-")+'</td>'+ 
                   '<td><button class="btn btn--ghost" data-i="'+i+'" data-action="ver">👁 Ver</button></td>'+ 
                   '<td>'+whatsappLink+'</td>'+ 
                   '<td>'+actionsHtml+'</td>'+ 
                 '</tr>'
               );
             }
         
             tbody.addEventListener('click', (e) => {
               console.log('🖱️ Click detectado no tbody:', e.target);
               const btn = e.target.closest('button[data-action]');
               if (!btn) {
                 console.log('❌ Nenhum botão com data-action encontrado');
                 return;
               }
         
               const i = Number(btn.getAttribute('data-i'));
               const item = cache[i] || {};
               const action = btn.getAttribute('data-action');
               
               console.log('✅ Botão clicado:', { action, index: i, item, cacheLength: cache.length });
         
               if (action === 'ver') {
                 console.log('👁️ Abrindo modal "Ver" para item:', item.titulo);
                 
                 let modalContent = (item.descricao || 'Nenhuma descrição disponível.').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                 
                 // Adicionar seção de anexos se houver (imagens e arquivos) — layout estilo lista
                 if (item.attachments && item.attachments.length > 0) {
                   modalContent += '<hr style="margin: 20px 0; border: 1px solid #ddd;">';
                   modalContent += '<h4 style="margin-bottom: 8px;">📎 Anexos (' + item.attachments.length + '):</h4>';
                   modalContent += `
                     <style>
                       .attachments-list-modern { margin-top: 6px; display: flex; flex-direction: column; gap: 6px; }
                       .attachment-row { display: flex; align-items: center; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 6px 8px; }
                       .att-left { width: 44px; height: 44px; border-radius: 8px; background: #eef1f4; display:flex; align-items:center; justify-content:center; margin-right: 8px; overflow:hidden; }
                       .att-left img { width: 100%; height: 100%; object-fit: cover; }
                       .att-chip { font-size: 11px; font-weight: 700; color: #495057; background:#e9ecef; padding: 5px 7px; border-radius: 6px; }
                       .att-center { flex: 1; min-width: 0; }
                       .att-name { font-size: 12.5px; font-weight: 600; color: #2f3237; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                       .att-sub { font-size: 11px; color: #6c757d; margin-top: 1px; }
                       .att-actions { display:flex; gap: 4px; margin-left: 8px; }
                       .att-btn { border:none; background:#eef1f4; color:#495057; width:26px; height:26px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
                       .att-btn:hover { background:#e1e6eb; }
                     </style>
                     <div class="attachments-list-modern">
                   `;
                   
                   item.attachments.forEach((att, idx) => {
                     const fileName = att.name || 'Arquivo';
                     const fileExt = (fileName.split('.').pop() || '').toLowerCase();
                     const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
                     const chip = fileExt ? fileExt.toUpperCase() : 'FILE';
                     const thumb = isImage
                       ? (() => { const p = (att.previews && att.previews.length>0) ? (att.previews.find(p=>p.width<=200)?.url || att.previews[0]?.url || att.url) : att.url; return `<img src="${p}" alt="${fileName}">`; })()
                       : `<span class=\"att-chip\">${chip}</span>`;
                     
                     modalContent += `
                       <div class="attachment-row" onclick="viewAttachment('${att.url}', '${fileName}', '${fileExt}')">
                         <div class="att-left">${thumb}</div>
                         <div class="att-center">
                           <div class="att-name" title="${fileName}">${fileName}</div>
                           <div class="att-sub">Adicionado há pouco</div>
                         </div>
                         <div class="att-actions" onclick="event.stopPropagation();">
                           <button class="att-btn" title="Abrir" onclick="window.open('${att.url}','_blank')">↗</button>
                           <button class="att-btn" title="Copiar link" onclick="copyToClipboard('${att.url}')">⋯</button>
                         </div>
                       </div>
                     `;
                   });
                   
                   modalContent += '</div>';
                 }
                 
                 openModal('📄 Descrição do chamado', modalContent);
                 return;
               }
               if (action === 'detalhes') {
                 console.log('📋 Abrindo modal "Detalhes" para item:', item.titulo);
                 const created = inferCreatedAt(item);
                 const lastAct = item.ultima_atividade ? new Date(item.ultima_atividade) : null;
                 const isLive  = /^(em aberto|em análise)$/i.test(item.status||'');
         
                 const startTs = (created ? created.getTime() : (lastAct ? lastAct.getTime() : Date.now()));
                 const stopTs  = isLive ? Date.now() : (lastAct ? lastAct.getTime() : startTs);
         
                 let html = '';
                 html += `📋 Título: ${(item.titulo || '-').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}<br>`;
                 html += `👤 Representante: ${(item.representante || '-') }<br>`;
                 html += `📊 Status: ${(item.status || '-') }<br><br>`;
                 html += `🕐 Criado em: ${created ? created.toLocaleString('pt-BR') : '—'}<br>`;
                 html += `⏰ Última atividade: ${lastAct ? lastAct.toLocaleString('pt-BR') : '—'}<br><br>`;
                 html += `⏱ Duração ${isLive?'(contando)':'(fechada)'}: <span id="durSpan">calculando…</span>`;
                 
                 // Adicionar seção de anexos se existirem
                 if (item.attachments && item.attachments.length > 0) {
                   html += `<br><br>📎 <strong>Anexos (${item.attachments.length}):</strong><br>`;
                   html += `<div class="attachments-list" style="margin-top: 10px;">`;
                   
                   item.attachments.forEach((att, index) => {
                     const fileName = att.name || 'Arquivo';
                     const fileExt = fileName.split('.').pop()?.toLowerCase() || '';
                     let iconPath = '/static/file.svg';
                     
                     // Determinar se é imagem, vídeo ou outro tipo de arquivo
                     const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt);
                     const isVideo = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExt);
                     
                     if (fileExt === 'pdf') iconPath = '/static/pdf.svg';
                     else if (['doc', 'docx'].includes(fileExt)) iconPath = '/static/docx.svg';
                     else if (['xls', 'xlsx'].includes(fileExt)) iconPath = '/static/xlsx.svg';
                     else if (['ppt', 'pptx'].includes(fileExt)) iconPath = '/static/pptx.svg';
                     else if (fileExt === 'txt') iconPath = '/static/txt.svg';
                     else if (fileExt === 'csv') iconPath = '/static/csv.svg';
                     
                     let thumbnailHtml = '';
                     if (isImage) {
                       // Para imagens, usar preview ou URL original
                       const previewUrl = (att.previews && att.previews.length > 0) ? 
                         att.previews.find(p => p.width <= 60)?.url || att.previews[0]?.url || att.url : att.url;
                       thumbnailHtml = `<img src="${previewUrl}" alt="${fileName}" style="width: 24px; height: 24px; margin-right: 4px; flex-shrink: 0; border-radius: 2px; object-fit: cover; border: 1px solid #ddd;">`;
                     } else if (isVideo) {
                       // Para vídeos, mostrar thumbnail com ícone de play
                       thumbnailHtml = `
                         <div style="position: relative; width: 24px; height: 24px; margin-right: 4px; flex-shrink: 0; background: #000; border-radius: 2px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;">
                           <video style="width: 100%; height: 100%; object-fit: cover; border-radius: 2px;" muted>
                             <source src="${att.url}" type="video/${fileExt}">
                           </video>
                           <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; opacity: 0.8;">
                             <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor">
                               <path d="M8 5v14l11-7z"/>
                             </svg>
                           </div>
                         </div>`;
                     } else {
                       // Para outros arquivos, usar ícone
                       thumbnailHtml = `<img src="${iconPath}" alt="${fileExt}" style="width: 14px; height: 14px; margin-right: 4px;">`;
                     }
                     
                     html += `
                       <div class="attachment-item" style="display: flex; align-items: center; padding: 3px 4px; margin-bottom: 1px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 2px; cursor: pointer;" 
                            onclick="viewAttachment('${att.url}', '${fileName}', '${fileExt}')">
                         ${thumbnailHtml}
                         <div style="flex: 1; font-size: 11px; color: #495057;">${fileName}</div>
                         <div style="font-size: 9px; color: #6c757d;">há pouco</div>
                       </div>`;
                   });
                   
                   html += `</div>`;
                 }
         
                 openModal('Detalhes do chamado', html);
         
                 function tick(){
                   const now = isLive ? Date.now() : stopTs;
                   const ms  = now - startTs;
                   const el  = document.getElementById('durSpan');
                   if (el) el.textContent = fmtDur(ms);
                 }
                 tick();
                 if (isLive) { if (window.__timerId) clearInterval(window.__timerId); window.__timerId = setInterval(tick, 1000); }
               }
             });
         
             // Mudar status: envia requisição e atualiza a tabela
             let pendingStatusChanges = new Map(); // Adicionar no início do initPainel
         
         tbody.addEventListener('change', async (e) => {
         const sel = e.target.closest('select.status-select');
         if (!sel) return;
         
         const cardId = sel.getAttribute('data-id');
         if (!cardId) return;
         
         // Evitar múltiplas mudanças simultâneas no mesmo card
         if (pendingStatusChanges.has(cardId)) {
         sel.value = sel.getAttribute('data-prev') || sel.value;
         return;
         }
         
         const prev = sel.getAttribute('data-prev') || sel.value;
         const newStatus = sel.value;
         
         // Marcar como pendente
         pendingStatusChanges.set(cardId, true);
         
         // feedback visual imediato
         sel.style.color = statusColor(newStatus);
         sel.disabled = true;
         
         try {
             const r = await fetch('/api/chamados/' + encodeURIComponent(cardId) + '/status', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               credentials: 'same-origin',
               body: JSON.stringify({ status: newStatus })
             });
             const resp = await r.json().catch(()=>({}));
         
             if (!r.ok || !resp || !resp.success) {
               // rollback
               sel.value = prev;
               sel.style.color = statusColor(prev);
               alert((resp && resp.message) || 'Erro ao atualizar status.');
             } else {
               // sucesso: fixa o novo valor como "último"
               sel.setAttribute('data-prev', newStatus);
             }
           } catch (err) {
             // rollback em erro de rede
             sel.value = prev;
             sel.style.color = statusColor(prev);
             alert('Erro ao atualizar status: ' + err.message);
           } finally {
         // Sempre remover do mapa de pendentes
         pendingStatusChanges.delete(cardId);
         sel.disabled = false;
         }
         });
         
         // --- Manter o dropdown de status aberto sem ser fechado por refresh ---
         tbody.addEventListener('focusin', (e) => {
         const sel = e.target.closest('select.status-select');
         if (!sel) return;
         // Entrou em edição: não re-renderizar tabela enquanto estiver focado
         isEditingStatus = true;
         });
         
         tbody.addEventListener('focusout', (e) => {
         const sel = e.target.closest('select.status-select');
         if (!sel) return;
         // Saiu do select de status: espera o foco realmente sair (próximo tick)
         setTimeout(() => {
         const stillFocused = tbody.querySelector('select.status-select:focus');
         if (!stillFocused) {
         isEditingStatus = false;
         // Se houver dados pendentes acumulados durante a edição, aplica agora
         if (pendingRenderData) {
         const { items, silent } = pendingRenderData;
         pendingRenderData = null;
         render(items, { silent: true }); // aplica em modo silencioso
         }
         }
         }, 0);
         });
         
         // Opcional: se clicar em qualquer lugar fora da tabela, encerra edição
         document.addEventListener('mousedown', (e) => {
         if (isEditingStatus && !e.target.closest('#tbl')) {
         isEditingStatus = false;
         if (pendingRenderData) {
         const { items, silent } = pendingRenderData;
         pendingRenderData = null;
         render(items, { silent: true });
         }
         }
         });
         
         
             function render(items,{silent=false}={}){
               const prev = lastKeys;
               tbody.innerHTML = items.length ? items.map(buildRowHTML).join('') :
                 '<tr><td class="empty" colspan="8">📋 Nenhum chamado encontrado.<br><span style="font-size:14px;opacity:.7;">Ajuste os filtros ou verifique a busca.</span></td></tr>';
          applyStatusSelectColors(tbody);
               if (silent){
                 [...tbody.querySelectorAll('tr[data-key]')].forEach(tr=>{
                   const k=tr.getAttribute('data-key'); if(!prev.has(k)) tr.classList.add('row-new');
                 });
               }
               lastKeys = new Set(items.map(it => it.id || it.url || it.titulo));
               cache = items;
             }
         
             function qs(){
               const p=[]; const rep=repSelect.value.trim(), st=statusSelect.value.trim(), de=deInput.value, ate=ateInput.value, q=qInput.value.trim();
               if(rep) p.push('representante='+encodeURIComponent(rep));
               if(st)  p.push('status='+encodeURIComponent(st));
               if(de)  p.push('de='+encodeURIComponent(de));
               if(ate) p.push('ate='+encodeURIComponent(ate));
               if(q)   p.push('q='+encodeURIComponent(q));
               return p.length ? '?'+p.join('&') : '';
             }
         
             // Fetch com timeout e tratamento de retorno não-JSON
             function withTimeout(promise, ms, controller){
         let to;
         const timeout = new Promise((_, rej) => {
         to = setTimeout(() => {
         try { controller?.abort(); } catch(e){}
         rej(new Error('Timeout após ' + ms + 'ms'));
         }, ms);
         });
         return Promise.race([promise, timeout]).finally(() => clearTimeout(to));
         }
         function load({silent=false, append=false}={}) {
         // 1) Se havia uma requisição anterior, aborta primeiro
         if (abortController) {
         try {
         abortController.abort();
         console.log('🚫 Fetch anterior abortado');
         } catch (e) {}
         }
         
         // 2) Agora cria um NOVO controller para esta chamada
         abortController = new AbortController();
         const { signal } = abortController;
         
         console.log('📥 Load chamado:', { silent, append, page, isRealTimeActive });
         
         const currentId = ++latestLoadId;
         
         // Exibe spinner se necessário
         if(!silent){
           tbody.innerHTML = '<tr><td class="empty" colspan="8"><div class="loading"></div> Carregando chamados...</td></tr>';
         }
         
         const query = qs();
         const sep = query ? '&' : '?';
         const cacheBuster = Date.now();
         const url = '/api/chamados' + query + sep + 'offset=' + (page * pageSize) + '&limit=' + pageSize + '&_=' + cacheBuster;
         
         const fetchPromise = fetch(url, { signal: abortController.signal,
           cache: 'no-store',
           credentials: 'same-origin',
           headers: { 
             'Accept': 'application/json, text/plain;q=0.9, */*;q=0.8',
             'Cache-Control': 'no-cache'
           },
           signal
         });
         
         return withTimeout(fetchPromise, (isRealTimeActive ? 15000 : 45000), abortController)
           .then(async r => {
             // Se não for a chamada mais recente, ignore
             if(currentId !== latestLoadId) {
               console.log('🗑️ Resposta descartada (stale):', currentId, 'vs', latestLoadId);
               throw new Error('Stale');
             }
             
             const ct = r.headers.get('content-type') || '';
             const text = await r.text();
             
             if(!r.ok) throw new Error('HTTP ' + r.status + ' ' + r.statusText + '\n' + text.slice(0,800));
             
             let data;
             try {
               data = ct.includes('application/json') ? JSON.parse(text) : JSON.parse(text);
             } catch(e){
               throw new Error('Conteúdo não-JSON da API:\n' + text.slice(0,800));
             }
             
             return Array.isArray(data) ? { items: data, total: data.length } : data;
           })
           .then(j => {
             // Ignora se não for a resposta mais recente
             if(currentId !== latestLoadId) {
               console.log('🗑️ Dados descartados (stale):', currentId);
               return;
             }
             
             console.log('✅ Load concluído ID:', currentId);
             
             const items = (j.items || []).map(x => {
               x.prioridade = x.prioridade || (x.descricao || '').match(/\*\*Prioridade:\*\*\s*([^\n]+)/i)?.[1] || '-';
               return x;
             });
             
             totalItems = j.total ?? items.length;
             
             // Se estiver editando o status e monitoramento ativo, não re-renderiza agora.
         // Em vez disso, guarda como pendente para aplicar quando a edição terminar.
         const shouldDeferRender = isEditingStatus && isRealTimeActive;
         
         if (append && page > 0) {
         const combined = cache.concat(items);
         const next = (combined.length > 500) ? combined.slice(-500) : combined;
         
         if (shouldDeferRender) {
         pendingRenderData = { items: next, silent: true };
         cache = next;
         } else {
         render(next, { silent });
         cache = next;
         }
         } else {
         // Se o monitoramento em tempo real está ativo e já temos dados no cache,
         // faz merge inteligente para preservar dados existentes
         if (isRealTimeActive && cache.length > 0 && !append) {
           // Cria um mapa dos IDs existentes para evitar duplicatas
           const existingIds = new Set(cache.map(item => item.id));
           // Adiciona apenas novos itens que não existem no cache
           const newItems = items.filter(item => !existingIds.has(item.id));
           // Atualiza itens existentes com dados mais recentes
           const updatedCache = cache.map(cachedItem => {
             const updatedItem = items.find(item => item.id === cachedItem.id);
             return updatedItem || cachedItem;
           });
           // Combina dados atualizados com novos itens
           const mergedItems = [...updatedCache, ...newItems];
           
           if (shouldDeferRender) {
             pendingRenderData = { items: mergedItems, silent: true };
             cache = mergedItems;
           } else {
             render(mergedItems, { silent });
             cache = mergedItems;
           }
         } else {
           // Comportamento normal quando não está em monitoramento ou cache vazio
           if (shouldDeferRender) {
             pendingRenderData = { items, silent: true };
             cache = items;
           } else {
             render(items, { silent });
             cache = items;
           }
         }
         }
         
             
             // Atualiza contagem
             countBox.innerHTML = `📊 <strong>${totalItems}</strong> chamado${totalItems!==1?'s':''} no total`;
             
             // Mostra/oculta paginação
             if(cache.length < totalItems){
               pagination.style.display = 'block';
             } else {
               pagination.style.display = 'none';
             }
           })
           .catch(err => {
             // Se foi abortado ou é stale, não mostra erro
             if(err.name === 'AbortError' || err.message === 'Stale') {
               console.log('ℹ️ Requisição ignorada:', err.message);
               return;
             }
             
             console.error('❌ Erro no load:', err);
             
             const msg = String((err && err.message) || err);
             countBox.innerHTML = '⚠️ Erro ao carregar dados';
             
             // Botão "Tentar novamente"
             const retryBtn = '<button onclick="window.location.reload()" style="margin-top:8px;padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">🔄 Tentar Novamente</button>';
             
             tbody.innerHTML = '<tr><td class="empty" colspan="8">⚠️ Erro ao carregar chamados.<br><pre style="white-space:pre-wrap;margin-top:8px;color:#7f1d1d;background:#fff3f3;border:1px solid #fecaca;padding:10px;border-radius:8px;max-height:160px;overflow:auto">' +
               msg.replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m])) +
             '</pre>' + retryBtn + '</td></tr>';
             
             // Re-throw para que os chamadores saibam que houve erro
             throw err;
           });
         }
         
             // Aplica filtros: reseta a página e recarrega
             btnAplicar.addEventListener('click', () => {
               // Se o monitoramento estiver ativo, desativa sem recarregar automaticamente
               if(isRealTimeActive){
                 isRealTimeActive = false;
                 cleanupRealTime();
                 btnRealtime.classList.remove('is-on');
                 btnRealtime.innerHTML = '<span class="dot"></span> Monitoramento em Tempo Real';
               }
               page = 0;
               load({silent:false});
             });
             // Limpa filtros: reseta campos, página e recarrega
             btnLimpar.addEventListener('click', () => {
               // Se o monitoramento estiver ativo, desativa sem recarregar automaticamente
               if(isRealTimeActive){
                 isRealTimeActive = false;
                 cleanupRealTime();
                 btnRealtime.classList.remove('is-on');
                 btnRealtime.innerHTML = '<span class="dot"></span> Monitoramento em Tempo Real';
               }
               repSelect.value = '';
               statusSelect.value = '';
               deInput.value = '';
               ateInput.value = '';
               qInput.value = '';
               page = 0;
               load({silent:false});
             });
             // Paginação: carregar mais
             btnMore.addEventListener('click', () => {
               page++;
               load({silent:false, append:true});
             });
             // Busca incremental no campo de texto (debounce)
             let searchTimer = null;
             qInput.addEventListener('input', () => {
               if (searchTimer) clearTimeout(searchTimer);
               searchTimer = setTimeout(() => {
                 page = 0;
                 load({silent:false});
               }, 400);
             });
             // Carga inicial
             load({silent:false});
         
             // Garante que qualquer conexão SSE ou pesquisa em curso seja encerrada ao sair ou atualizar a página.
             window.addEventListener('beforeunload', () => {
         try { 
         cleanupRealTime(); 
         // Aborta qualquer fetch ainda pendente
         if(abortController) {
         abortController.abort();
         abortController = null;
         }
         } catch(e){}
         });
           })();
      </script>
      <script>
         // ====== A4 Viewer State ======
         const A4State = {
           pages: [],      // array de strings HTML, cada item = 1 página
           current: 1,     // página atual (1..N)
           zoom: 1         // 1 = 100%
         };
         
         function a4UpdateToolbar() {
           const pageInfo = document.getElementById('a4-page-info');
           const zoomInfo = document.getElementById('a4-zoom-info');
           const total = Math.max(1, A4State.pages.length);
           pageInfo.textContent = `Página ${A4State.current}/${total}`;
           zoomInfo.textContent = `${Math.round(A4State.zoom*100)}%`;
         }
         
         function a4ShowPage(n) {
           const total = Math.max(1, A4State.pages.length);
           A4State.current = Math.min(Math.max(1, n), total);
           const pages = document.querySelectorAll('#a4-pages .a4-page');
           pages.forEach((pg, i) => {
             pg.hidden = (i !== (A4State.current - 1));
           });
           a4UpdateToolbar();
         }
         
         function a4SetZoom(z) {
         // trava zoom entre 50% e 300%
         A4State.zoom = Math.min(3, Math.max(.5, z));
         
         // Se o PAN estiver carregado, delega para ele aplicar o transform
         if (window.a4PanSetZoom) {
         window.a4PanSetZoom(A4State.zoom);
         } else {
         // fallback antigo: variável CSS
         const wrap = document.getElementById('a4-viewer-wrap');
         wrap.style.setProperty('--zoom', String(A4State.zoom));
         }
         
         a4UpdateToolbar();
         }
         
         
         function a4BindButtons() {
           document.getElementById('a4-print')?.addEventListener('click', () => window.print());
           document.getElementById('a4-zoom-in')?.addEventListener('click', () => a4SetZoom(A4State.zoom + 0.1));
           document.getElementById('a4-zoom-out')?.addEventListener('click', () => a4SetZoom(A4State.zoom - 0.1));
           document.getElementById('a4-first')?.addEventListener('click', () => a4ShowPage(1));
           document.getElementById('a4-prev')?.addEventListener('click', () => a4ShowPage(A4State.current - 1));
           document.getElementById('a4-next')?.addEventListener('click', () => a4ShowPage(A4State.current + 1));
           document.getElementById('a4-last')?.addEventListener('click', () => a4ShowPage(A4State.pages.length || 1));
         }
         
         // API: define as páginas do relatório (cada item do array é o HTML de uma página)
         function setA4Pages(pagesHTMLArray) {
           const host = document.getElementById('a4-pages');
           host.innerHTML = '';
           A4State.pages = Array.isArray(pagesHTMLArray) ? pagesHTMLArray : [];
         
           if (A4State.pages.length === 0) {
             // página vazia padrão
             const empty = document.createElement('div');
             empty.className = 'a4-page';
             empty.innerHTML = `<div class="a4-empty">
               <div>
                 <h3 style="margin:0 0 8px 0;">Relatório</h3>
                 <p>Nenhum conteúdo definido ainda.</p>
               </div>
             </div>`;
             host.appendChild(empty);
           } else {
             A4State.pages.forEach(html => {
               const pg = document.createElement('div');
               pg.className = 'a4-page';
               pg.innerHTML = html;
               host.appendChild(pg);
             });
           }
           A4State.current = 1;
           a4ShowPage(1);
         }
         
         document.addEventListener('DOMContentLoaded', () => {
           a4BindButtons();
           a4SetZoom(1);
           // inicializa com 1 página vazia
           setA4Pages([]);
         });
      </script>
      </script>   <!-- fecha o bloco atual do A4 Viewer -->
      <script>
         // ====== PAN (ARRASTAR) NO A4 ======
         (function () {
           const wrap  = document.getElementById('a4-viewer-wrap');
           const pages = document.getElementById('a4-pages');
         
           let zoom = 1;
           let panX = 0, panY = 0;
           let isPanning = false;
           let startX = 0, startY = 0;
           let startPanX = 0, startPanY = 0;
         
           function apply() {
             pages.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
           }
         
           // <<< CHAMADO PELO a4SetZoom >>>
           window.a4PanSetZoom = function (z) {
             zoom = Math.max(0.5, Math.min(3, z));
             if (zoom > 1) {
               wrap.classList.add('a4-can-pan');
             } else {
               wrap.classList.remove('a4-can-pan', 'a4-panning');
               panX = 0; panY = 0;   // volta pro centro no zoom 100%
             }
             apply();
             const zi = document.getElementById('a4-zoom-info');
             if (zi) zi.textContent = Math.round(zoom * 100) + '%';
           };
         
           // Inicia pan ao clicar em QUALQUER lugar do viewer (se zoom > 1)
           wrap.addEventListener('mousedown', (e) => {
             if (zoom <= 1) return;
             isPanning = true;
             wrap.classList.add('a4-panning');
             startX = e.clientX; startY = e.clientY;
             startPanX = panX;   startPanY = panY;
             e.preventDefault();
           });
         
           // Move enquanto arrasta
           window.addEventListener('mousemove', (e) => {
             if (!isPanning) return;
             panX = startPanX + (e.clientX - startX);
             panY = startPanY + (e.clientY - startY);
             apply();
           });
         
           // Finaliza pan
           function endPan(){
             if (!isPanning) return;
             isPanning = false;
             wrap.classList.remove('a4-panning');
           }
           window.addEventListener('mouseup', endPan);
           wrap.addEventListener('mouseleave', endPan);
         
           // Estado inicial
           window.addEventListener('DOMContentLoaded', () => window.a4PanSetZoom(1));
         })();
      </script>
      <script>
         // ===== Liga a barra de ações (Relatórios) ao viewer A4 =====
         document.getElementById('btnPrintRel')?.addEventListener('click', () => window.print());
         document.getElementById('btnZoomInRel')?.addEventListener('click', () => a4SetZoom(A4State.zoom + 0.1));
         document.getElementById('btnZoomOutRel')?.addEventListener('click', () => a4SetZoom(A4State.zoom - 0.1));
         document.getElementById('btnFirstPageRel')?.addEventListener('click', () => a4ShowPage(1));
         document.getElementById('btnPrevPageRel')?.addEventListener('click', () => a4ShowPage(A4State.current - 1));
         document.getElementById('btnNextPageRel')?.addEventListener('click', () => a4ShowPage(A4State.current + 1));
         document.getElementById('btnLastPageRel')?.addEventListener('click', () => a4ShowPage(A4State.pages.length || 1));
         
         // Ao entrar na aba Relatórios, garante A4 visível (sem "lista antiga")
         document.querySelector('[data-target="#relatorios"]')?.addEventListener('click', () => {
         if (!A4State.pages || A4State.pages.length === 0) setA4Pages([]); // mostra 1 página A4 vazia
         });
      </script>
      <script>
         // ====== Botão Confirmar (Relatórios) ======
         (function hookConfirmarRelatorio(){
           const btn = document.getElementById('btnConfirmarRel');
           if (!btn) return;
         
           btn.addEventListener('click', async (e) => {
             e.preventDefault();
         
             // 1) Ler opções do usuário
             const tipoRel = document.querySelector('input[name="tipoRelatorio"]:checked')?.value || 'sintetico';
             const agrupar = document.querySelector('input[name="agruparPor"]:checked')?.value || 'cliente';
         
             // 2) Montar parâmetros da URL + datas
             const params = new URLSearchParams();
             const inicio = document.getElementById('relInicio').value;
             const fim    = document.getElementById('relFim').value;
         
             // >>> BLOQUEIA se as datas não estiverem preenchidas <<<
              if (!inicio || !fim) {
                // pinta de vermelho os campos vazios
                ['relInicio','relFim'].forEach(id=>{
                  const el = document.getElementById(id);
                  if (el) {
                    el.style.borderColor = (!el.value ? '#ef4444' : 'var(--stroke)');
                    el.style.boxShadow   = (!el.value ? '0 0 0 3px rgba(239,68,68,.25)' : 'none');
                  }
                });
         
                // abre modal de aviso
                const modal = document.getElementById('requireDatesModal');
                if (modal) modal.style.display = 'flex';
         
                // rola e foca no primeiro campo vazio
                const targetId = !inicio ? 'relInicio' : 'relFim';
                const targetEl = document.getElementById(targetId);
                if (targetEl){
                  targetEl.scrollIntoView({behavior:'smooth', block:'center'});
                  setTimeout(()=> targetEl.focus(), 300);
                }
         
                return; // não continua
              }
         
         
         
             // remove destaque se já corrigiu
             ['relInicio','relFim'].forEach(id=>{
               const el = document.getElementById(id);
               if (el) { el.style.borderColor = 'var(--stroke)'; el.style.boxShadow = 'none'; }
             });
         
             // agora que validou, grava as datas nos params
             params.set('de',  inicio);
             params.set('ate', fim);
             params.set('require_dates', '1');
         
             // tipo de chamado
             const tipoChamado = document.querySelector('input[name="tipoChamado"]:checked')?.value || 'todos';
             if (tipoChamado !== 'todos') {
               params.set('tipo', tipoChamado);
             }
         
             // filtros extras (cliente, representante, sistema, módulo, ocorrência)
             if (document.getElementById('chkClienteRel').checked) {
               const v = document.getElementById('fClienteRel').value;
               if (v) params.set('cliente', v);
             }
             if (document.getElementById('chkRepresentanteRel').checked) {
               const v = document.getElementById('fRepresentanteRel').value;
               if (v) params.set('representante', v);
             }
             if (document.getElementById('chkSistemaRel').checked) {
               const v = document.getElementById('fSistemaRel').value;
               if (v) params.set('sistema', v);
             }
             if (document.getElementById('chkModuloRel').checked) {
               const v = document.getElementById('fModuloRel').value;
               if (v) params.set('modulo', v);
             }
             if (document.getElementById('chkOcorrenciaRel').checked) {
               const v = document.getElementById('fOcorrenciaRel').value;
               if (v) params.set('ocorrencia', v);
             }
         
             // GUARDA a query para exportação (agora sim, depois da validação)
             __lastReportQuery = params.toString();
         
             // 3) Faz a chamada
             let respJson = {};
             try {
               const resp = await fetch('/api/chamados?' + params.toString(), {
                 credentials: 'same-origin',
                 cache: 'no-store',
                 headers: { 'Accept': 'application/json' }
               });
         
               // Se o backend retornou erro (ex.: 400) tratamos aqui
               if (!resp.ok) {
                 let msg = 'Erro ao buscar dados do relatório.';
                 try {
                   const errJson = await resp.json();
                   if (errJson && (errJson.message || errJson.error)) {
                     msg = errJson.message || errJson.error;
                   }
                 } catch(_) { /* mantém msg padrão */ }
         
                 setA4Pages([`
                   <div class="a4-page">
                     <div style="padding:12mm; font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                       <h2 style="margin:0 0 8px 0; color:#b91c1c;">Não foi possível gerar o relatório</h2>
                       <p>${msg}</p>
                     </div>
                   </div>
                 `]);
                 return;
               }
         
               respJson = await resp.json();
             } catch (err) {
               setA4Pages([`
                 <div class="a4-page">
                   <div style="padding:12mm; font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                     <h2 style="margin:0 0 8px 0; color:#b91c1c;">Erro de conexão</h2>
                     <p>${(err && err.message) ? err.message : 'Falha ao consultar o servidor.'}</p>
                   </div>
                 </div>
               `]);
               return;
             }
         
             // 4) Pega só a lista de chamados
             const dados = respJson.items || [];
             console.log("Dados recebidos no relatório:", dados);
         
             // 5) Gerar HTML conforme o tipo escolhido
             let paginas = [];
             if (tipoRel === 'sintetico') {
               paginas = gerarSintetico(dados, agrupar);
             } else {
               paginas = gerarAnalitico(dados, agrupar);
             }
         
             // 6) Mostrar no viewer A4
             // se vier em 1 única string longa, paginar; se vier array, concatenar e paginar
             const html = Array.isArray(paginas) ? paginas.join('') : String(paginas || '');
             const paginadas = paginateHtmlToA4(html);
             setA4Pages(paginadas);
           });
         })();
         
         // Util: formata AAAA-MM-DD -> DD/MM/AAAA
         function fmtData(d) {
           if (!d) return '';
           const [yyyy, mm, dd] = d.split('-');
           return `${dd}/${mm}/${yyyy}`;
         }
         
         function gerarSintetico(dados, agrupar){
           const ini = document.getElementById('relInicio').value;
           const fim = document.getElementById('relFim').value;
           const periodo = (ini || fim) ? `Período de ${fmtData(ini || fim)} a ${fmtData(fim || ini)}` : '';
         
           const header = (titulo) => `
             <div class="rpt-header">
               <div class="rpt-title">${titulo}</div>
               <div class="rpt-period">${periodo}</div>
             </div>
           `;
         
           if (agrupar === 'cliente') {
             const mapa = {};
             dados.forEach(d => {
               const cli = d.cliente || 'Sem Cliente';
               const rep = (d.representante || '').trim() || '—';
               if (!mapa[cli]) mapa[cli] = { representante: rep, quant: 0 };
               mapa[cli].quant++;
             });
         
             const linhas = Object.entries(mapa)
               .sort((a,b) => a[0].localeCompare(b[0], 'pt-BR'))
               .map(([cliente, info]) => `
                 <tr>
                   <td>${cliente}</td>
                   <td>${info.representante}</td>
                   <td class="num">${info.quant}</td>
                 </tr>
               `);
         
             const total = Object.values(mapa).reduce((s, g) => s + g.quant, 0);
         
             const tabela = `
               <table class="rpt-table">
                 <thead>
                   <tr>
                     <th>Cliente</th>
                     <th>Representante</th>
                     <th class="num">Quant.</th>
                   </tr>
                 </thead>
                 <tbody>
                   ${linhas.join('')}
                 </tbody>
               </table>
             `;
             const totalSolto = `<div class="rpt-total-inline">Quantidade de Chamados: <span class="num">${total}</span></div>`;
             const conteudo = header('Curva ABC de Chamados por Cliente') + tabela + totalSolto;
             return [conteudo];
           }
         
           // agrupado por REPRESENTANTE
           const mapaRep = {};
           dados.forEach(d => {
             const rep = (d.representante || '').trim() || 'Sem Representante';
             mapaRep[rep] = (mapaRep[rep] || 0) + 1;
           });
         
           const linhasRep = Object.entries(mapaRep)
             .sort((a,b) => a[0].localeCompare(b[0], 'pt-BR'))
             .map(([rep, q]) => `
               <tr>
                 <td>${rep}</td>
                 <td class="num">${q}</td>
               </tr>
             `);
         
           const totalRep = Object.values(mapaRep).reduce((s, n) => s + n, 0);
         
           const tabelaRep = `
             <table class="rpt-table">
               <thead>
                 <tr>
                   <th>Representante</th>
                   <th class="num">Quant.</th>
                 </tr>
               </thead>
               <tbody>
                 ${linhasRep.join('')}
               </tbody>
             </table>
           `;
           const totalSoltoRep = `<div class="rpt-total-inline">Quantidade de Chamados: <span class="num">${totalRep}</span></div>`;
           const conteudoRep = header('Curva ABC de Chamados por Representante') + tabelaRep + totalSoltoRep;
           return [conteudoRep];
         }
         
         function gerarAnalitico(dados, agrupar){
         // período no cabeçalho
         const ini = document.getElementById('relInicio').value;
         const fim = document.getElementById('relFim').value;
         const periodo = (ini || fim)
         ? `Período de ${fmtData(ini || fim)} a ${fmtData(fim || ini)}`
         : '';
         
         // cabeçalho do relatório (igual ao sintético)
         const header = (titulo) => `
         <div class="rpt-header">
         <div class="rpt-title">${titulo}</div>
         <div class="rpt-period">${periodo}</div>
         </div>
         `;
         
         // agrupamento
         const key = (agrupar === 'representante') ? 'representante' : 'cliente';
         const tituloRel = (agrupar === 'representante')
         ? 'Relação de Chamados por Representantes'
         : 'Relação de Chamados por Cliente';
         
         // grupos
         const grupos = {};
         dados.forEach(d => {
         const k = (d[key] || (agrupar==='representante' ? 'Sem Representante' : 'Sem Cliente')).trim();
         if (!grupos[k]) grupos[k] = [];
         grupos[k].push(d);
         });
         
         // contador total geral
         let totalGeral = 0;
         
         // largura FIXA das colunas (soma ~100%)
         // (com table-layout: fixed, o navegador respeita esse colgroup)
         const colgroup = `
         <colgroup>
         <col style="width:20%">
         <col style="width:20%">
         <col style="width:30%">
         <col style="width:20%">
         <col style="width:10%">
         </colgroup>
         `;
         
         // para cada grupo, tabela + subtotal "solto"
         const blocos = Object
         .entries(grupos)
         .sort((a,b) => a[0].localeCompare(b[0], 'pt-BR'))
         .map(([grupoNome, items]) => {
         const subtotal = items.length;
         totalGeral += subtotal;
         
         const linhas = items.map(it => {
         const tipoRaw = (it.tipo || '').toString();
         const tipoFmt = tipoRaw
          ? (tipoRaw.charAt(0).toUpperCase() + tipoRaw.slice(1).toLowerCase())
          : '';
         return `
          <tr>
            <td>${it.sistema || ''}</td>
            <td>${it.modulo || ''}</td>
            <td>${it.ocorrencia || ''}</td>
            <td>${tipoFmt}</td>
            <td class="num">1</td>
          </tr>
         `;
         }).join('');
         
         // tabela do grupo + subtotal FORA da tabela
         return `
         <table class="rpt-table" style="margin-top:10px;">
          ${colgroup}
          <thead>
            <tr><th class="rpt-group-name" colspan="5">${grupoNome}</th></tr>
            <tr>
              <th>Sistema</th>
              <th>Módulo</th>
              <th>Ocorrência</th>
              <th>Tipo</th>
              <th class="num">Quant.</th>
            </tr>
          </thead>
          <tbody>
            ${linhas}
          </tbody>
         </table>
         <div class="rpt-subtotal-inline">
          Quantidade de Chamados: <span class="num">${subtotal}</span>
         </div>
         `;
         });
         
         // título geral + blocos + total geral com linha
         const conteudo =
         header(tituloRel) +
         blocos.join('') +
         `<div class="rpt-total-inline rpt-with-sep">Total de Chamados: <span class="num">${totalGeral}</span></div>`;
         
         return [conteudo];
         }
         
         
         // Amarra min/max entre as datas
         (function bindDateBounds(){
           const ini = document.getElementById('relInicio');
           const fim = document.getElementById('relFim');
           if (!ini || !fim) return;
         
           ini.addEventListener('change', () => {
             if (ini.value) fim.min = ini.value;
             if (fim.value && ini.value && fim.value < ini.value) fim.value = ini.value;
           });
           fim.addEventListener('change', () => {
             if (fim.value) ini.max = fim.value;
             if (ini.value && fim.value && ini.value > fim.value) ini.value = fim.value;
           });
         })();
      </script>
      <script>
         // ====== Funções do CADASTRO ======
         function getCsrfToken(){
           const m = document.cookie.match(/(?:^|; )csrf_token=([^;]+)/);
           return m ? decodeURIComponent(m[1]) : '';
         }
         function criarRep(e) {
           e.preventDefault();
           const formData = new FormData(e.target);
           formData.append('csrf_token', getCsrfToken());
           fetch('/admin/rep/new', {
             method: 'POST',
             body: formData,
             headers: { 'X-Requested-With': 'XMLHttpRequest' },
             credentials: 'same-origin'
           })
             .then(res => {
               if(res.ok) return res.json();
               throw new Error('HTTP ' + res.status);
             })
             .then(data => {
               if(!data || !data.ok){
                 alert('Erro ao adicionar representante');
                 return;
               }
               const reps = data.reps || [];
               // Atualiza a tabela de representantes
               const tbody = document.querySelector('#t-reps tbody');
               if(tbody){
                 let html = '';
                 reps.forEach(r => {
                   html += '<tr data-id="'+r.id+'">'+
                             '<td><strong>'+r.nome+'</strong></td>'+
                             '<td class="actions">'+
                               '<button class="btn btn--ghost" type="button" onclick="removerRep('+r.id+')">Remover</button>'+
                             '</td>'+
                           '</tr>';
                 });
                 if(!html){
                   html = '<tr><td colspan="2" class="empty-state">Nenhum representante cadastrado</td></tr>';
                 }
                 tbody.innerHTML = html;
               }
               // Atualiza o select de representantes no cadastro de usuários
               const repSel = document.querySelector('select[name="representative_id"]');
               if(repSel){
                 const opts = ['<option value="">Selecione o representante</option>'];
                 reps.forEach(r => {
                   opts.push('<option value="'+r.id+'">'+r.nome+'</option>');
                 });
                 repSel.innerHTML = opts.join('');
               }
               // Reseta o formulário
               e.target.reset();
             })
             .catch(err => {
               alert('Erro: ' + err.message);
             });
           return false;
         }
         
         
         function criarUser(e) {
           e.preventDefault();
           const formData = new FormData(e.target);
           formData.append('csrf_token', getCsrfToken());
           
           fetch('/admin/user/new', {
             method: 'POST',
             body: formData,
             headers: { 'X-Requested-With': 'XMLHttpRequest' },
             credentials: 'same-origin'
           })
             .then(res => {
               if (res.ok) return res.json();
               throw new Error('HTTP ' + res.status);
             })
             .then(data => {
               if (!data || !data.ok) {
                 alert('Erro ao adicionar usuário');
                 return;
               }
               const users = data.users || [];
               // 👉 Atualiza a tabela de usuários com a coluna "Senha" + olhinho
               renderUsers(users);
         
               // Reseta o formulário
               e.target.reset();
             })
             .catch(err => {
               alert('Erro: ' + err.message);
             });
           return false;
         }
         
         
         function renderUsers(users){
           const tbody = document.querySelector('#t-users tbody');
           if(!tbody) return;
           let html = '';
           (users || []).forEach(u => {
             const repName = u.representante || '';
             const pwd = u.password || '';
             html += '<tr data-id="'+u.id+'">'+
                       '<td><strong>'+u.username+'</strong></td>'+
                       '<td><span class="pill">'+repName+'</span></td>'+
                       '<td>'+
                         '<div class="pwd-cell">'+
                           '<input class="pwd-input" type="password" value="'+pwd.replaceAll('"','&quot;')+'" readonly>'+
         '<button class="btn-eye" type="button" onclick="togglePwd(this)"><svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>'+
                         '</div>'+
                       '</td>'+
                       '<td class="actions">'+
                         '<button class="btn btn--ghost" type="button" onclick="removerUser('+u.id+')">Remover</button>'+
                       '</td>'+
                     '</tr>';
           });
           if(!html){
             html = '<tr><td colspan="4" class="empty-state">Nenhum usuário cadastrado</td></tr>';
           }
           tbody.innerHTML = html;
         }
         
         
         function togglePwd(btn){
           const input = btn && btn.parentElement ? btn.parentElement.querySelector('.pwd-input') : null;
           if(!input) return;
           
           if(input.type === 'password'){
             input.type = 'text';
             // Mesmo olho, mas com linha diagonal
             btn.innerHTML = '<svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><line x1="3" y1="3" x2="21" y2="21"/></svg>';
           } else {
             input.type = 'password';
             // Olho normal (sem linha)
             btn.innerHTML = '<svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>';
           }
         }
         
         
         // ====== Script da aba de Relatórios ======
         // Este script habilita/desabilita os campos de filtro adicionais conforme as checkboxes
         // são marcadas ou desmarcadas.
         (() => {
           // Aguarda o carregamento do DOM para garantir que os elementos existam
           document.addEventListener('DOMContentLoaded', () => {
             const advFilters = [
               { chk: 'chkClienteRel', field: 'fClienteRel' },
               { chk: 'chkRepresentanteRel', field: 'fRepresentanteRel' },
               { chk: 'chkSistemaRel', field: 'fSistemaRel' },
               { chk: 'chkModuloRel', field: 'fModuloRel' },
               { chk: 'chkOcorrenciaRel', field: 'fOcorrenciaRel' }
             ];
             advFilters.forEach(({ chk, field }) => {
               const c = document.getElementById(chk);
               const f = document.getElementById(field);
               if (!c || !f) return;
               // Define estado inicial
               f.disabled = !c.checked;
               c.addEventListener('change', () => {
                 f.disabled = !c.checked;
                 if (!c.checked) {
                   // Limpa o valor quando desabilitar
                   if (f.tagName === 'SELECT') f.selectedIndex = 0;
                   else f.value = '';
                 }
               });
             });
           });
         })();
      </script>
      <script>
         document.addEventListener('DOMContentLoaded', async () => {
           async function carregarRepresentantes() {
             try {
               const res = await fetch('/api/representantes', { headers: { 'Accept':'application/json' }, cache:'no-store' });
               const lista = await res.json();
               preencherSelect('fRepresentanteRel', lista, /*placeholder*/'');
               // Se existir um select no Painel:
               preencherSelect('fRep', lista, /*placeholder*/'');
             } catch (e) {
               console.error('Falha ao carregar representantes:', e);
             }
           }
         
           function preencherSelect(id, nomes, placeholder) {
             const el = document.getElementById(id);
             if (!el) return;
             el.innerHTML = '';
             // Se quiser uma opção "todas", use value vazio
             if (placeholder !== null) {
               const optAll = document.createElement('option');
               optAll.value = ''; optAll.textContent = placeholder || 'Todos';
               el.appendChild(optAll);
             }
             (nomes || []).forEach(n => {
               const o = document.createElement('option');
               o.value = n; o.textContent = n;
               el.appendChild(o);
             });
           }
         
           await carregarRepresentantes();
         });
      </script>
      <script>
         async function removerRep(id) {
           // Abre o modal
           const modal = document.getElementById("confirmDeleteModal");
           modal.style.display = "flex";
         
           // Botão "Sim, quero remover"
           document.getElementById("btnConfirmDelete").onclick = async () => {
             modal.style.display = "none";
             try {
               const res = await fetch('/admin/rep/' + id + '/delete', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                 credentials: 'same-origin',
                 body: JSON.stringify({ confirm: true })
               });
               const data = await res.json();
               if (!res.ok || !data.ok) {
                 alert(data.message || 'Erro ao remover representante');
                 return;
               }
         
               // Atualiza a tabela de representantes
               const repTbody = document.querySelector('#t-reps tbody');
               if (repTbody) {
                 let html = '';
                 (data.reps || []).forEach(r => {
                   html += '<tr data-id="'+r.id+'">'+
                             '<td><strong>'+r.nome+'</strong></td>'+
                             '<td class="actions">'+
                               '<button class="btn btn--ghost" type="button" onclick="removerRep('+r.id+')">Remover</button>'+
                             '</td>'+
                           '</tr>';
                 });
                 if (!html) {
                   html = '<tr><td colspan="2" class="empty-state">Nenhum representante cadastrado</td></tr>';
                 }
                 repTbody.innerHTML = html;
               }
         
               // Atualiza a tabela de usuários
               if (data.users) renderUsers(data.users);
         
         
               alert(data.message || 'Representante removido com sucesso');
             } catch (e) {
               alert('Erro: ' + e.message);
             }
           };
         
           // Botão "Cancelar"
           document.getElementById("btnCancelDelete").onclick = () => {
             modal.style.display = "none";
           };
         }
         
         
         
         async function removerUser(id) {
           // Abre o modal
           const modal = document.getElementById("confirmDeleteUserModal");
           modal.style.display = "flex";
         
           // Botão "Sim, quero remover"
           document.getElementById("btnConfirmDeleteUser").onclick = async () => {
             modal.style.display = "none";
             try {
               const res = await fetch('/admin/user/' + id + '/delete', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                 credentials: 'same-origin'
               });
               const data = await res.json();
               if (!res.ok || !data.ok) {
                 alert(data.message || 'Erro ao remover usuário');
                 return;
               }
         
               // Atualiza a tabela de usuários
               renderUsers(data.users || []);
         
         
               alert(data.message || 'Usuário removido com sucesso');
             } catch (e) {
               alert('Erro: ' + e.message);
             }
           };
         
           // Botão "Cancelar"
           document.getElementById("btnCancelDeleteUser").onclick = () => {
             modal.style.display = "none";
           };
         }
         
      </script>
      <script src="/static/data.js"></script>
      <script>
         // Utilidades de popular/limpar
         function fillSelect(selectEl, items, placeholder = "Selecione.") {
           selectEl.innerHTML = "";
           const opt = document.createElement("option");
           opt.value = "";
           opt.textContent = placeholder;
           selectEl.appendChild(opt);
         
           (items || []).forEach(({ value, label }) => {
             const o = document.createElement("option");
             o.value = value;
             o.textContent = label;
             selectEl.appendChild(o);
           });
         }
         
         // ======== AJUSTADAS PARA FUNCIONAR COM AMBOS FORMATOS DE data.js ========
         
         // 1) Sistemas
         function getSystems() {
           const D = window.DATA || {};
           // Formato 1: DATA.Sistemas = [{ nome, modulos: [...] }]
           if (Array.isArray(D.Sistemas)) {
             return D.Sistemas.map(s => ({ value: s.nome, label: s.nome }));
           }
           // Formato 2: DATA = { "WebLider": { "Cadastro": [...] }, "Lider PDV": {...} }
           return Object.keys(D).map(k => ({ value: k, label: k }));
         }
         
         // 2) Módulos por Sistema
         function getModulesBySystem(systemName) {
           const D = window.DATA || {};
           // Formato 1 (array):
           if (Array.isArray(D.Sistemas)) {
             const sys = (D.Sistemas || []).find(s => s.nome === systemName);
             if (!sys) return [];
             // Pode ser [{nome, ocorrencias}] ou array de strings
             if (Array.isArray(sys.modulos) && sys.modulos.length && typeof sys.modulos[0] === "object") {
               return sys.modulos.map(m => ({ value: m.nome, label: m.nome }));
             }
             if (Array.isArray(sys.modulos)) {
               return sys.modulos.map(m => ({ value: m, label: m }));
             }
             return [];
           }
           // Formato 2 (mapa):
           if (D[systemName] && typeof D[systemName] === "object") {
             return Object.keys(D[systemName]).map(m => ({ value: m, label: m }));
           }
           return [];
         }
         
         // 3) Ocorrências por Sistema + Módulo
         function getOccurrencesBySystemModule(systemName, moduleName) {
           const D = window.DATA || {};
           // Formato 1 (array):
           if (Array.isArray(D.Sistemas)) {
             const sys = (D.Sistemas || []).find(s => s.nome === systemName);
             if (!sys) return [];
             const modObj = (sys.modulos || []).find(m =>
               (typeof m === "object" ? m.nome : m) === moduleName
             );
             if (!modObj) return [];
             const ocorrs = Array.isArray(modObj.ocorrencias) ? modObj.ocorrencias : [];
             return ocorrs.map(o => ({ value: o, label: o }));
           }
           // Formato 2 (mapa):
           const ocorrs = (D[systemName] && D[systemName][moduleName]) || [];
           return (ocorrs || []).map(o => ({ value: o, label: o }));
         }
         
         // Liga os checkboxes e encadeia os selects
         function setupRelatorioChainedSelects() {
           const chkSis   = document.getElementById("chkSistemaRel");
           const chkMod   = document.getElementById("chkModuloRel");
           const chkOcor  = document.getElementById("chkOcorrenciaRel");
         
           const selSis   = document.getElementById("fSistemaRel");
           const selMod   = document.getElementById("fModuloRel");
           const selOcor  = document.getElementById("fOcorrenciaRel");
         
           // Estado inicial
           selSis.disabled  = !chkSis.checked;
           selMod.disabled  = !chkMod.checked;
           selOcor.disabled = !chkOcor.checked;
         
           if (chkSis.checked) {
             fillSelect(selSis, getSystems());
           } else {
             fillSelect(selSis, []);
             selSis.value = "";
           }
           // Mod e Ocor sempre começam limpos
           fillSelect(selMod, []);
           fillSelect(selOcor, []);
         
         // Se já estiver marcado "Módulo" e já houver um Sistema selecionado, preenche agora
         if (chkMod.checked && selSis.value) {
         fillSelect(selMod, getModulesBySystem(selSis.value));
         }
         
         // Se já estiver marcado "Ocorrência" e já houver Sistema+Módulo, preenche agora
         if (chkOcor.checked && selSis.value && selMod.value) {
         fillSelect(selOcor, getOccurrencesBySystemModule(selSis.value, selMod.value));
         }
         
         
         
           // Quando marcar/desmarcar "Sistema"
           chkSis.addEventListener("change", () => {
             selSis.disabled = !chkSis.checked;
             // Limpamos cadeia inteira abaixo
             fillSelect(selSis, chkSis.checked ? getSystems() : []);
             selSis.value = "";
             fillSelect(selMod, []);
             fillSelect(selOcor, []);
           });
         
           // Quando marcar/desmarcar "Módulo"
         chkMod.addEventListener("change", () => {
         selMod.disabled = !chkMod.checked;
         // sempre limpa as ocorrências ao mexer no módulo
         fillSelect(selOcor, []);
         selOcor.value = "";
         
         if (!chkMod.checked) {
         // desmarcou: limpa o select de módulo
         fillSelect(selMod, []);
         selMod.value = "";
         return;
         }
         
         // marcou: se já existe um Sistema escolhido, preenche agora
         if (selSis.value) {
         fillSelect(selMod, getModulesBySystem(selSis.value));
         } else {
         fillSelect(selMod, []);
         selMod.value = "";
         }
         });
         
         
         
           // Quando marcar/desmarcar "Ocorrência"
         chkOcor.addEventListener("change", () => {
         selOcor.disabled = !chkOcor.checked;
         
         if (!chkOcor.checked) {
         // desmarcou: limpa
         fillSelect(selOcor, []);
         selOcor.value = "";
         return;
         }
         
         // marcou: se já existe Sistema e Módulo escolhidos, preenche agora
         if (selSis.value && selMod.value) {
         fillSelect(selOcor, getOccurrencesBySystemModule(selSis.value, selMod.value));
         } else {
         fillSelect(selOcor, []);
         selOcor.value = "";
         }
         });
         
         
           // Quando escolher um Sistema → carrega Módulos (se o checkbox de Módulo estiver ativo)
           selSis.addEventListener("change", () => {
             // sempre que o sistema mudar, limpamos o que vem depois
             fillSelect(selMod, []);
             fillSelect(selOcor, []);
             selMod.value = "";
             selOcor.value = "";
         
             if (chkMod.checked && selSis.value) {
               fillSelect(selMod, getModulesBySystem(selSis.value));
             }
           });
         
           // Quando escolher um Módulo → carrega Ocorrências (se o checkbox de Ocorrência estiver ativo)
           selMod.addEventListener("change", () => {
             fillSelect(selOcor, []);
             selOcor.value = "";
         
             if (chkOcor.checked && selSis.value && selMod.value) {
               fillSelect(selOcor, getOccurrencesBySystemModule(selSis.value, selMod.value));
             }
           });
         }
         
         // Inicializa quando a página carregar
         document.addEventListener("DOMContentLoaded", () => {
           try {
             setupRelatorioChainedSelects();
           } catch (e) {
             console.error("Erro ao configurar selects encadeados do relatório:", e);
           }
           const btnOk = document.getElementById('btnOkRequireDates');
           if (btnOk){
             btnOk.onclick = () => {
               const m = document.getElementById('requireDatesModal');
               if (m) m.style.display = 'none';
             };
           }
         });
      </script>
      <!-- Modal: Remover representante -->
      <div class="confirm-modal" id="confirmDeleteModal" style="display:none;">
         <div class="confirm__box">
            <div class="confirm__title">Remover representante</div>
            <div class="confirm__msg">
               Ao deletar um representante, todos os usuários vinculados a ele também serão deletados.<br>
               Deseja continuar?
            </div>
            <div class="confirm__actions">
               <button class="btn btn--secondary" id="btnConfirmDelete">Sim, quero remover</button>
               <button class="btn btn--ghost" id="btnCancelDelete">Cancelar</button>
            </div>
         </div>
      </div>
      <!-- Modal: Remover usuário -->
      <div class="confirm-modal" id="confirmDeleteUserModal" style="display:none;">
         <div class="confirm__box">
            <div class="confirm__title">Remover usuário</div>
            <div class="confirm__msg">
               Deseja realmente remover este usuário?
            </div>
            <div class="confirm__actions">
               <button class="btn btn--secondary" id="btnConfirmDeleteUser">Sim, quero remover</button>
               <button class="btn btn--ghost" id="btnCancelDeleteUser">Cancelar</button>
            </div>
         </div>
      </div>
      
      <!-- Modal do Visualizador de Imagens -->
      <div id="imageViewerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
        <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;">
          <button id="closeImageViewer" style="position: absolute; top: -40px; right: 0; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10001;">×</button>
          
          <button id="prevImage" style="position: absolute; left: -60px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">‹</button>
          
          <img id="viewerImage" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);" />
          
          <button id="nextImage" style="position: absolute; right: -60px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">›</button>
          
          <div id="imageCounter" style="position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); color: white; font-size: 14px; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;"></div>
        </div>
      </div>
      
      <!-- Modal: Datas obrigatórias para relatório -->
      <div class="confirm-modal" id="requireDatesModal" style="display:none;">
         <div class="confirm__box">
            <div class="confirm__title">Datas obrigatórias</div>
            <div class="confirm__msg">
               Selecione <strong>Data Inicial</strong> e <strong>Data Final</strong> para gerar o relatório.
            </div>
            <div class="confirm__actions">
               <button id="btnOkRequireDates" class="btn btn--primary" type="button">OK</button>
            </div>
            

            
            <script>
         // Guarda o último filtro de relatório aplicado (para travar exportação se não houver busca)
          let __lastReportQuery = null;
          

         
         // Lê os filtros da aba Relatórios e monta os parâmetros que a API entende
         // Mapeamento: sistema -> sistema, módulo -> modulo, ocorrência -> ocorrencia
         function getReportFiltersAsParams() {
           const params = new URLSearchParams();
         
           // Período (datas) - usa "de" e "ate" (última atividade) ou troque para "de_criacao/ate_criacao" se preferir criar por data de criação
           const dtIni = document.getElementById('relInicio')?.value || '';
           const dtFim = document.getElementById('relFim')?.value || '';
           if (dtIni) params.set('de', dtIni);
           if (dtFim) params.set('ate', dtFim);
         
           // Tipo de relatório (não é filtro da API, mas pode ser útil no front)
           const tipoRel = (document.querySelector('input[name="tipoRelatorio"]:checked') || {}).value || 'sintetico';
           params.set('tipo_rel', tipoRel);
         
           // Agrupar por (também é preferência do front)
           const agrupar = (document.querySelector('input[name="agruparPor"]:checked') || {}).value || 'cliente';
           params.set('agrupar_por', agrupar);
         
           // Tipo de Chamado (duvida/melhoria/bug/todos) -> se != todos, mandamos como "tipo"
           const tipoChamado = (document.querySelector('input[name="tipoChamado"]:checked') || {}).value || 'todos';
           if (tipoChamado && tipoChamado !== 'todos') {
             params.set('tipo', tipoChamado);
           }
         
           // Cliente (texto livre)
           const chkCliente = document.getElementById('chkClienteRel')?.checked;
           const vCliente   = document.getElementById('fClienteRel')?.value?.trim();
           if (chkCliente && vCliente) params.set('cliente', vCliente);
         
           // Representante
           const chkRep = document.getElementById('chkRepresentanteRel')?.checked;
           const vRep   = document.getElementById('fRepresentanteRel')?.value;
           if (chkRep && vRep) params.set('representante', vRep);
         
           // Sistema → campo "sistema" do cartão
           const chkSis = document.getElementById('chkSistemaRel')?.checked;
           const vSis   = document.getElementById('fSistemaRel')?.value;
           if (chkSis && vSis) params.set('sistema', vSis);
         
           // Módulo → campo "modulo" do cartão
           const chkMod = document.getElementById('chkModuloRel')?.checked;
           const vMod   = document.getElementById('fModuloRel')?.value;
           if (chkMod && vMod) params.set('modulo', vMod);
         
           // Ocorrência → campo "ocorrencia" do cartão
           const chkOco = document.getElementById('chkOcorrenciaRel')?.checked;
           const vOco   = document.getElementById('fOcorrenciaRel')?.value;
           if (chkOco && vOco) params.set('ocorrencia', vOco);
         
           // Paginação (opcional): podemos começar do offset 0 e definir um limit
           params.set('offset', '0');
           params.set('limit', '1000'); // ajuste se quiser
         
           return params;
         }
         
         
         // Exportação CSV/XLS — só permite se já houve "Confirmar" (temos __lastReportQuery)
         function onExportRel(format) {
           if (!__lastReportQuery) {
             alert('É necessário buscar um relatório antes de exportar.');
             return;
           }
           // Reusa exatamente a última query + formato desejado
           const url = '/api/chamados/export?format=' + encodeURIComponent(format) + '&' + __lastReportQuery;
           // Abre em nova aba / inicia o download
           window.open(url, '_blank');
         }
         
         // Visualizador de Imagens
         let currentImages = [];
         let currentImageIndex = 0;
         
         function openImageViewer(images, startIndex = 0) {
           currentImages = images;
           currentImageIndex = startIndex;
           
           const modal = document.getElementById('imageViewerModal');
           const img = document.getElementById('viewerImage');
           const counter = document.getElementById('imageCounter');
           
           updateViewerImage();
           modal.style.display = 'flex';
           
           // Adicionar event listeners se ainda não foram adicionados
           if (!modal.hasAttribute('data-listeners-added')) {
             document.getElementById('closeImageViewer').addEventListener('click', closeImageViewer);
             document.getElementById('prevImage').addEventListener('click', prevImage);
             document.getElementById('nextImage').addEventListener('click', nextImage);
             
             // Fechar com ESC
             document.addEventListener('keydown', function(e) {
               if (e.key === 'Escape' && modal.style.display === 'flex') {
                 closeImageViewer();
               }
             });
             
             // Navegação com setas
             document.addEventListener('keydown', function(e) {
               if (modal.style.display === 'flex') {
                 if (e.key === 'ArrowLeft') prevImage();
                 if (e.key === 'ArrowRight') nextImage();
               }
             });
             
             // Fechar clicando no fundo
             modal.addEventListener('click', function(e) {
               if (e.target === modal) {
                 closeImageViewer();
               }
             });
             
             modal.setAttribute('data-listeners-added', 'true');
           }
         }
         
         function updateViewerImage() {
           const img = document.getElementById('viewerImage');
           const counter = document.getElementById('imageCounter');
           const prevBtn = document.getElementById('prevImage');
           const nextBtn = document.getElementById('nextImage');
           
           if (currentImages.length > 0) {
             img.src = currentImages[currentImageIndex].url;
             counter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
             
             // Mostrar/ocultar botões de navegação
             prevBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
             nextBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
           }
         }
         
         function closeImageViewer() {
           document.getElementById('imageViewerModal').style.display = 'none';
         }
         
         function prevImage() {
           if (currentImages.length > 1) {
             currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
             updateViewerImage();
           }
         }
         
         function nextImage() {
           if (currentImages.length > 1) {
             currentImageIndex = (currentImageIndex + 1) % currentImages.length;
             updateViewerImage();
           }
         }
         
         // Função para visualizar anexos
         function viewAttachment(url, fileName, fileExt) {
           const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExt.toLowerCase());
           const isVideo = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExt.toLowerCase());
           const isText = ['txt', 'csv'].includes(fileExt.toLowerCase());
           const isPdf = fileExt.toLowerCase() === 'pdf';
           
           if (isImage) {
             // Visualizar imagem em modal
             const modalContent = `
               <div style="text-align: center; max-width: 90vw; max-height: 90vh;">
                 <h3 style="margin-bottom: 20px; color: #333;">${fileName}</h3>
                 <img src="${url}" alt="${fileName}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                 <div style="margin-top: 20px;">
                   <button onclick="window.open('${url}', '_blank')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Abrir Original</button>
                   <button onclick="downloadFile('${url}', '${fileName}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Salvar</button>
                 </div>
               </div>`;
             openModal('Visualizar Imagem', modalContent);
           } else if (isVideo) {
             // Visualizar vídeo em modal
             const modalContent = `
               <div style="text-align: center; max-width: 90vw; max-height: 90vh;">
                 <h3 style="margin-bottom: 20px; color: #333;">${fileName}</h3>
                 <video controls style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                   <source src="${url}" type="video/${fileExt}">
                   Seu navegador não suporta a reprodução de vídeo.
                 </video>
                 <div style="margin-top: 20px;">
                   <button onclick="window.open('${url}', '_blank')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Abrir Original</button>
                   <button onclick="downloadFile('${url}', '${fileName}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Salvar</button>
                 </div>
               </div>`;
             openModal('Visualizar Vídeo', modalContent);
           } else if (isText) {
             // Visualizar texto em modal
             fetch(url)
               .then(response => response.text())
               .then(text => {
                 const modalContent = `
                   <div style="max-width: 90vw; max-height: 90vh;">
                     <h3 style="margin-bottom: 20px; color: #333;">${fileName}</h3>
                     <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; max-height: 60vh; overflow-y: auto; font-family: monospace; white-space: pre-wrap; font-size: 14px;">${text}</div>
                     <div style="margin-top: 20px; text-align: center;">
                       <button onclick="window.open('${url}', '_blank')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Abrir Original</button>
                       <button onclick="downloadFile('${url}', '${fileName}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Salvar</button>
                     </div>
                   </div>`;
                 openModal('Visualizar Arquivo', modalContent);
               })
               .catch(error => {
                 console.error('Erro ao carregar arquivo:', error);
                 showDownloadOnlyModal(url, fileName);
               });
           } else if (isPdf) {
             // Visualizar PDF em modal
             const modalContent = `
               <div style="text-align: center; max-width: 95vw; max-height: 95vh;">
                 <h3 style="margin-bottom: 20px; color: #333;">${fileName}</h3>
                 <iframe src="${url}" style="width: 100%; height: 75vh; border: 1px solid #dee2e6; border-radius: 5px;"></iframe>
                 <div style="margin-top: 20px;">
                   <button onclick="window.open('${url}', '_blank')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Abrir Original</button>
                   <button onclick="downloadFile('${url}', '${fileName}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Salvar</button>
                 </div>
               </div>`;
             openModal('Visualizar PDF', modalContent);
           } else {
             // Mostrar modal de download para outros tipos
             showDownloadOnlyModal(url, fileName);
           }
         }
         
         function showDownloadOnlyModal(url, fileName) {
           const modalContent = `
             <div style="text-align: center; padding: 20px;">
               <div style="font-size: 48px; margin-bottom: 20px;">📄</div>
               <h3 style="margin-bottom: 15px; color: #333;">${fileName}</h3>
               <p style="color: #666; margin-bottom: 25px;">Não há visualização disponível para este anexo</p>
               <button onclick="downloadFile('${url}', '${fileName}')" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px;">Salvar</button>
             </div>`;
           openModal('Anexo', modalContent);
         }
         
         function downloadFile(url, fileName) {
           const link = document.createElement('a');
           link.href = url;
           link.download = fileName;
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
         }
         
         function copyToClipboard(text) {
           if (navigator.clipboard && navigator.clipboard.writeText) {
             navigator.clipboard.writeText(text).catch(() => {});
           } else {
             const ta = document.createElement('textarea');
             ta.value = text;
             document.body.appendChild(ta);
             ta.select();
             try { document.execCommand('copy'); } catch (e) {}
             document.body.removeChild(ta);
           }
         }
         
         // Liga os botões quando a página carregar
         document.addEventListener('DOMContentLoaded', () => {
           const btnConfirm = document.getElementById('btnConfirmarRel');
           const btnCsv = document.getElementById('btnCsvRel');
           const btnXls = document.getElementById('btnXlsRel');
         
           btnCsv?.addEventListener('click', () => onExportRel('csv'));
           btnXls?.addEventListener('click', () => onExportRel('xlsx')); // sua rota aceita 'xlsx'
         });
      </script>
      <script src="/static/js/pdf-export.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
      
   </body>
</html>