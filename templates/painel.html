<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Painel de Chamados</title>

  <!-- Favicons / PWA -->
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#006056">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root{
      --ink:#0f172a;--muted:#64748b;--stroke:#e2e8f0;--bg:#f8fafc;--surface:#fff;
      --primary:#006056;--primary-dark:#004e47;--primary-light:#e0f2fe;
      --success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;
      --error:#ef4444;--error-light:#fee2e2;--purple:#8b5cf6;--purple-light:#f3e8ff;
      --shadow:0 4px 6px -1px rgb(0 0 0/.1),0 2px 4px -2px rgb(0 0 0/.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
      --radius:12px;--radius-lg:16px;
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial;margin:0;background:linear-gradient(135deg,var(--bg) 0%,#e2e8f0 100%);color:var(--ink);min-height:100vh;line-height:1.5}
    .wrap{max-width:1400px;margin:0 auto;padding:32px 24px}

    /* Header */
    .header{display:flex;align-items:center;gap:14px;margin:0 0 24px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{width:52px;height:52px;border-radius:10px;display:block;object-fit:contain;box-shadow:0 6px 18px rgba(0,0,0,.08);background:#fff}
    .titlebox h1{margin:0;font-size:32px;font-weight:800;letter-spacing:-.02em;color:#065f5b}
    .titlebox .subtitle{margin:6px 0 0;color:var(--muted);font-size:15px}

    /* Filtros */
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;background:var(--surface);padding:24px;border:1px solid var(--stroke);border-radius:var(--radius-lg);box-shadow:var(--shadow);backdrop-filter:blur(10px);margin-bottom:24px}
    .filter-group{display:flex;flex-direction:column;gap:8px}
    .filters label{font-size:14px;color:var(--ink);font-weight:600;letter-spacing:-.025em}
    .input,.select{width:100%;padding:12px 16px;border:2px solid var(--stroke);border-radius:var(--radius);background:var(--surface);font-size:14px;font-weight:500;outline:none;transition:.2s cubic-bezier(.4,0,.2,1);color:var(--ink)}
    .input:focus,.select:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light);transform:translateY(-1px)}
    .input::placeholder{color:var(--muted)}

    .actions{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
    .actions .push-right{margin-left:auto}
    .btn{border:2px solid var(--stroke);background:var(--surface);border-radius:var(--radius);padding:12px 20px;cursor:pointer;font-weight:600;font-size:14px;transition:.2s cubic-bezier(.4,0,.2,1);display:inline-flex;align-items:center;gap:8px;text-decoration:none;position:relative;overflow:hidden}
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .btn--primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff;border-color:var(--primary-dark)}
    .btn--primary:hover{background:linear-gradient(135deg,var(--primary-dark) 0%,#0369a1 100%)}
    .btn--live{background:linear-gradient(135deg,var(--success) 0%,#059669 100%);color:#fff;border-color:#059669}
    .btn--live.is-on{animation:pulse 2s infinite;box-shadow:0 0 0 4px rgba(16,185,129,.3)}
    .btn--live.is-on::after{content:'';width:8px;height:8px;border-radius:50%;background:#10b981;margin-left:6px;display:inline-block;box-shadow:0 0 0 0 rgba(16,185,129,.6);animation:pulseDot 1.6s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 4px rgba(16,185,129,.3)}50%{box-shadow:0 0 0 8px rgba(16,185,129,.1)}}
    @keyframes pulseDot{to{box-shadow:0 0 0 10px rgba(16,185,129,0)}}

    .count{font-size:14px;color:var(--muted);font-weight:500;margin-bottom:16px;padding:12px 16px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--stroke)}

    /* Tabela */
    .table-container{background:var(--surface);border:1px solid var(--stroke);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);overflow:hidden}
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:800px}
    th,td{padding:16px 20px;border-bottom:1px solid var(--stroke);font-size:14px;text-align:left}
    th{background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);font-weight:700;color:var(--ink);position:sticky;top:0;z-index:10;letter-spacing:-.025em}
    th:nth-child(6),th:nth-child(7),td:nth-child(6),td:nth-child(7){text-align:center}
    tbody tr{transition:all .2s ease}
    tbody tr:hover{background:linear-gradient(135deg,var(--primary-light) 0%,var(--purple-light) 100%);transform:translateX(4px)}
    tbody tr:last-child td{border-bottom:none}
    .title{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;color:var(--ink)}
    .status{display:inline-flex;align-items:center;justify-content:center;padding:8px 16px;border-radius:50px;font-weight:700;font-size:12px;letter-spacing:.05em;text-transform:uppercase;min-width:160px;border:2px solid transparent}
    .s-open{background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);color:#92400e;border-color:#f59e0b}
    .s-analise{background:linear-gradient(135deg,var(--error-light) 0%,#fecaca 100%);color:#991b1b;border-color:var(--error)}
    .s-versao{background:linear-gradient(135deg,var(--warning-light) 0%,#fed7aa 100%);color:#ea580c;border-color:var(--warning)}
    .s-req{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);color:#1d4ed8;border-color:var(--primary)}
    .s-ok{background:linear-gradient(135deg,var(--success-light) 0%,#a7f3d0 100%);color:#065f46;border-color:var(--success)}
    .s-drop{background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:#475569;border-color:#808b98}
    .date{color:var(--ink);font-variant-numeric:tabular-nums;font-weight:500}
    .empty{padding:48px;text-align:center;color:var(--muted);font-size:16px;font-weight:500}

    .cell-btn{display:inline-flex;align-items:center;justify-content:center;min-width:110px;padding:8px 16px;border-radius:50px;border:2px solid var(--stroke);background:var(--surface);font-weight:600;text-decoration:none;cursor:pointer;transition:.2s cubic-bezier(.4,0,.2,1);font-size:12px;color:var(--ink)}
    .cell-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow);border-color:var(--primary)}
    .cell-btn--accent{border-color:#8b5cf6;background:linear-gradient(135deg,#f3e8ff 0%,#ede9fe 100%);color:#8b5cf6}
    .cell-btn--accent:hover{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);color:#fff}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.7);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal__box{width:min(800px,95vw);max-height:85vh;overflow:auto;background:#fff;border:1px solid var(--stroke);border-radius:var(--radius-lg);padding:32px;box-shadow:var(--shadow-lg)}
    .modal__title{font-weight:800;font-size:24px;margin:0 0 20px;background:linear-gradient(135deg,var(--primary) 0%,#8b5cf6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .modal__body{white-space:pre-wrap;border:2px solid var(--stroke);background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);border-radius:var(--radius);padding:20px;font-family:'SF Mono',ui-monospace,Consolas,Menlo,monospace;font-size:14px;line-height:1.6;color:var(--ink);max-height:400px;overflow-y:auto}
    .modal__actions{display:flex;justify-content:flex-end;gap:12px;margin-top:24px}

    /* motion safe */
    @media (prefers-reduced-motion:reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
    @media (max-width:768px){
      .wrap{padding:20px 16px}
      .filters{grid-template-columns:1fr;gap:16px;padding:20px}
      .actions{flex-direction:column;align-items:stretch}
      .actions .push-right{margin-left:0}
      .btn{justify-content:center}
      .modal__box{padding:24px}
      .titlebox h1{font-size:24px}
    }
    /* loader */
    .loading{display:inline-block;width:16px;height:16px;border:2px solid var(--stroke);border-radius:50%;border-top-color:var(--primary);animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <img src="/static/logo.png" alt="Logo do Painel">
      </div>
      <div class="titlebox">
        <h1>Painel de Chamados</h1>
        <p class="subtitle">Gerencie e monitore todos os seus chamados em tempo real</p>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>Representante</label>
        <select id="fRep" class="select">
          <option value="">Todos os representantes</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select id="fStatus" class="select">
          <option value="">Todos os status</option>
          <option>Em aberto</option>
          <option>Em análise</option>
          <option>Aguardando versão</option>
          <option>Aguardando Requisição</option>
          <option>Finalizado</option>
          <option>Descartado</option>
        </select>
      </div>
      <div class="filter-group"><label>Data inicial</label><input id="fDe" type="date" class="input"></div>
      <div class="filter-group"><label>Data final</label><input id="fAte" type="date" class="input"></div>
      <div class="filter-group"><label>Buscar por</label><input id="fQ" class="input" placeholder="Título ou descrição..."></div>
    </div>

    <div class="actions">
      <button class="btn btn--primary" id="btnAplicar">🔎 Aplicar Filtros</button>
      <button class="btn" id="btnLimpar">🧹 Limpar</button>
      <button class="btn btn--live push-right" id="btnRealtime">🔴 Monitoramento em Tempo Real</button>
    </div>

    <div class="count" id="countBox"></div>

    <div class="table-container">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Título</th>
              <th>Representante</th>
              <th>Status</th>
              <th>Detalhes</th>
              <th>Última Atividade</th>
              <th>Descrição</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="empty" colspan="7"><div class="loading"></div> Carregando chamados...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal__box">
      <h3 class="modal__title" id="modalTitle">Modal</h3>
      <div class="modal__body" id="modalBody"></div>
      <div class="modal__actions"><button class="btn" id="btnFecharModal">Fechar</button></div>
    </div>
  </div>

  <!-- Som da notificação -->
  <audio id="notifSound" src="/static/notify.mp3" preload="auto"></audio>

<script>
(()=>{
  const tbody = document.getElementById('tbody');
  const countBox = document.getElementById('countBox');
  const repSelect = fRep, statusSelect = fStatus, deInput = fDe, ateInput = fAte, qInput = fQ;
  const btnRealtime = document.getElementById('btnRealtime');
  const notifSound = document.getElementById('notifSound');

  /* opções de representantes (mesmas do formulário) */
  // Carrega a lista de representantes dinamicamente da API. Isso evita listas duplicadas no código.
  fetch('/api/representantes')
    .then(r => r.ok ? r.json() : [])
    .then(list => {
      if(Array.isArray(list) && list.length){
        list.forEach(r=>{
          const o=document.createElement('option');
          o.value=r; o.textContent=r;
          repSelect.appendChild(o);
        });
      }
    })
    .catch(() => {
      // Falha silenciosa; mantém apenas 'Todos os representantes'
    });

  const esc = s => String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
  const fmtDate = iso => !iso ? '-' : new Date(iso).toLocaleDateString('pt-BR')+' '+new Date(iso).toLocaleTimeString('pt-BR');
  const statusClass = s => {
    const x=(s||'').toLowerCase();
    if(x==='em aberto') return 'status s-open';
    if(x==='em análise') return 'status s-analise';
    if(x==='aguardando versão') return 'status s-versao';
    if(x==='aguardando requisição') return 'status s-req';
    if(x==='finalizado') return 'status s-ok';
    if(x==='descartado') return 'status s-drop';
    return 'status';
  };

  /** Tenta deduzir a data de criação; se não der, retorna null */
  function inferCreatedAt(item){
    if (item.created_at) return new Date(item.created_at);
    if (item.id && /^[0-9a-f]{24}$/i.test(item.id)) {
      const secs = parseInt(item.id.substring(0,8),16);
      if (!Number.isNaN(secs)) return new Date(secs*1000);
    }
    return null;
  }

  /* ===== Renderização ===== */
  let cache = []; let lastKeys = new Set();
  const rowKey = it => it.id || it.url || it.titulo || Math.random().toString(36).slice(2);

  const buildRowHTML = (it,i)=>`
    <tr data-key="${esc(rowKey(it))}">
      <td class="title" title="${esc(it.titulo)}">${esc(it.titulo)}</td>
      <td>${esc(it.representante||'-')}</td>
      <td><span class="${statusClass(it.status)}">${esc(it.status||'-')}</span></td>
      <td><button class="cell-btn" data-i="${i}" data-action="detalhes">📋 Detalhes</button></td>
      <td class="date">${fmtDate(it.ultima_atividade)}</td>
      <td><button class="cell-btn" data-i="${i}" data-action="ver">👁 Ver</button></td>
      <td>${it.url?`<a class="cell-btn cell-btn--accent" href="${esc(it.url)}" target="_blank" rel="noopener">🔗 Trello</a>`:'-'}</td>
    </tr>`;

  function render(items,{silent=false}={}){
    const prev = lastKeys;
    tbody.innerHTML = items.length ? items.map(buildRowHTML).join('') :
      '<tr><td class="empty" colspan="7">🔎 Nenhum chamado encontrado.<br><span style="font-size:14px;opacity:.7;">Ajuste os filtros ou verifique a busca.</span></td></tr>';
    if (silent){
      [...tbody.querySelectorAll('tr[data-key]')].forEach(tr=>{
        const k=tr.getAttribute('data-key'); if(!prev.has(k)) tr.classList.add('row-new');
      });
    }
    lastKeys = new Set(items.map(rowKey));
    cache = items;
  }

  function qs(){
    const p=[]; const rep=repSelect.value.trim(), st=statusSelect.value.trim(), de=deInput.value, ate=ateInput.value, q=qInput.value.trim();
    if(rep) p.push('representante='+encodeURIComponent(rep));
    if(st)  p.push('status='+encodeURIComponent(st));
    if(de)  p.push('de='+encodeURIComponent(de));
    if(ate) p.push('ate='+encodeURIComponent(ate));
    if(q)   p.push('q='+encodeURIComponent(q));
    return p.length ? '?'+p.join('&') : '';
  }

  function load({silent=false}={}){
    if(!silent) tbody.innerHTML='<tr><td class="empty" colspan="7"><div class="loading"></div> Carregando chamados...</td></tr>';
    return fetch('/api/chamados'+qs())
      .then(async r=>{ const ct=r.headers.get('content-type')||''; const t=await r.text(); if(!ct.includes('application/json')) throw new Error(t.slice(0,300)); return JSON.parse(t); })
      .then(j=>{
        render(j.items||[],{silent});
        const total = j.total ?? (j.items||[]).length;
        countBox.innerHTML = `📊 <strong>${total}</strong> chamado${total!==1?'s':''} encontrado${total!==1?'s':''}`;
      })
      .catch(err=>{
        console.error(err);
        if(!silent){
          countBox.innerHTML='❌ Erro ao carregar dados';
          tbody.innerHTML='<tr><td class="empty" colspan="7">⚠️ Erro ao carregar chamados.</td></tr>';
        }
      });
  }

  /* Aplicar & Limpar */
  btnAplicar.addEventListener('click',()=>{ stopRealtime(); load({silent:false}); });
  btnLimpar.addEventListener('click',()=>{
    if(!confirm('Deseja limpar todos os filtros e resultados?')) return;
    stopRealtime();
    repSelect.value=''; statusSelect.value=''; deInput.value=''; ateInput.value=''; qInput.value='';
    cache=[]; lastKeys=new Set(); countBox.innerHTML='🔎 Use os filtros para buscar chamados';
    tbody.innerHTML='<tr><td class="empty" colspan="7">🎯 Aplique filtros ou ative o Monitoramento.</td></tr>';
  });

  /* ===== Tempo real (opcional) ===== */
  let realtimeTimer=null;
  function startRealtime(){
    btnRealtime.classList.add('is-on');
    btnRealtime.innerHTML='⏹ Parar Monitoramento';
    statusSelect.value='Em aberto'; deInput.value=''; ateInput.value=''; qInput.value='';
    load({silent:false}).then(()=>{ realtimeTimer=setInterval(()=>load({silent:true}),6000); });
  }
  function stopRealtime(){
    btnRealtime.classList.remove('is-on');
    btnRealtime.innerHTML='🔴 Monitoramento em Tempo Real';
    if(realtimeTimer){ clearInterval(realtimeTimer); realtimeTimer=null; }
  }
  btnRealtime.addEventListener('click',()=> realtimeTimer ? stopRealtime() : startRealtime());

  /* ===== Modal ===== */
  const modal=document.getElementById('modal'), modalBody=document.getElementById('modalBody'), modalTitle=document.getElementById('modalTitle'), btnClose=document.getElementById('btnFecharModal');
  const openModal=(title,html)=>{ modalTitle.textContent=title; modalBody.innerHTML=html; modal.style.display='flex'; };
  const closeModal=()=>{ modal.style.display='none'; if(timerId){clearInterval(timerId);timerId=null;} };
  btnClose.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

  function fmtDur(ms){ if(ms<0) ms=0; const s=Math.floor(ms/1000); const d=Math.floor(s/86400); const h=String(Math.floor((s%86400)/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const sec=String(s%60).padStart(2,'0'); return (d? d+'d ': '')+`${h}:${m}:${sec}`; }
  let timerId=null;

  tbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action]'); if(!btn) return;
    const i=Number(btn.getAttribute('data-i')); const item=cache[i]||{};
    if(btn.getAttribute('data-action')==='ver'){
      openModal('📄 Descrição do chamado', esc(item.descricao||'Nenhuma descrição disponível.'));
      return;
    }
    if(btn.getAttribute('data-action')==='detalhes'){
      const created = inferCreatedAt(item);                                // pode ser null
      const lastAct = item.ultima_atividade ? new Date(item.ultima_atividade) : null;
      const isLive = /^(em aberto|em análise)$/i.test(item.status||'');

      // Fallbacks:
      // - se não souber o "created", usamos a primeira data confiável disponível (última atividade)
      const startTs = (created ? created.getTime() : (lastAct ? lastAct.getTime() : Date.now()));
      const stopTs  = isLive ? Date.now() : (lastAct ? lastAct.getTime() : startTs);

      let html = '';
      html += `📋 Título: ${esc(item.titulo||'-')}\n`;
      html += `📊 Status: ${esc(item.status||'-')}\n\n`;
      html += `🕐 Criado em: ${created ? created.toLocaleString('pt-BR') : '—'}\n`;
      html += `⏰ Última atividade: ${lastAct ? lastAct.toLocaleString('pt-BR') : '—'}\n\n`;
      html += `⏱ Duração ${isLive?'(contando)':'(fechada)'}: <span id="durSpan">calculando…</span>`;

      openModal('Detalhes do chamado', html);

      function tick(){
        const now = isLive ? Date.now() : stopTs;
        const ms = now - startTs;
        const el = document.getElementById('durSpan');
        if(el) el.textContent = fmtDur(ms);
      }
      tick();
      if(isLive){ timerId=setInterval(tick,1000); }
    }
  });

  /* ===== Notificações de novos "Em aberto" (sempre, independente do tempo real) ===== */

  // 1) Pede permissão de notificação de forma educada
  function ensureNotifPermission(){
    if(!('Notification' in window)) return;
    if(Notification.permission==='default'){
      // pede uma vez por sessão, ao primeiro carregamento
      Notification.requestPermission().catch(()=>{});
    }
  }
  ensureNotifPermission();

  // 2) Guarda os IDs já vistos de cards "Em aberto" (para não duplicar aviso)
  let seenOpenIds = new Set();

  // primeira carga do watcher: preenche o "seen" sem notificar
  function warmUpSeen(){
    fetch('/api/chamados?status='+encodeURIComponent('Em aberto'))
      .then(r=>r.ok?r.json():{items:[]})
      .then(j=>{
        (j.items||[]).forEach(it=>seenOpenIds.add(it.id||it.url||it.titulo));
      })
      .catch(()=>{});
  }
  warmUpSeen();

  function notifyNew(item){
    try{
      const title = 'Novo chamado em aberto';
      const body  = `${item.titulo || 'Sem título'}\nRep.: ${item.representante || '-'}${item.status ? ' • '+item.status : ''}`;
      if('Notification' in window && Notification.permission==='granted'){
        const n = new Notification(title,{ body, icon:'/static/icon-192.png', tag: (item.id||item.url||item.titulo) });
        n.onclick = ()=>{ if(item.url) window.open(item.url,'_blank'); };
      }
      // toca som (não bloqueante)
      if (notifSound) { notifSound.currentTime = 0; notifSound.play().catch(()=>{}); }
    }catch(e){}
  }

  // 3) Watcher silencioso a cada 30s, independente do tempo real
  setInterval(()=>{
    fetch('/api/chamados?status='+encodeURIComponent('Em aberto'))
      .then(r=>r.ok?r.json():{items:[]})
      .then(j=>{
        (j.items||[]).forEach(it=>{
          const key = it.id||it.url||it.titulo;
          if(!seenOpenIds.has(key)){
            seenOpenIds.add(key);
            notifyNew(it);
          }
        });
      })
      .catch(()=>{ /* silencioso */ });
  }, 5000);

  // Carrega tabela inicial
  load({silent:false});
})();
</script>
</body>
</html>
